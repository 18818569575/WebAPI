package org.ohdsi.webapi.cohortresults;

import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.ohdsi.webapi.service.CohortAnalysisService;
import org.springframework.batch.core.StepContribution;
import org.springframework.batch.core.scope.context.ChunkContext;
import org.springframework.batch.core.step.tasklet.Tasklet;
import org.springframework.batch.repeat.RepeatStatus;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.CallableStatementCreator;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.SqlParameter;

public class CohortAnalysisTasklet implements Tasklet {
	
	@Autowired
	private CohortAnalysisService analysisService;
    
    private static final Log log = LogFactory.getLog(CohortAnalysisTasklet.class);
    
    private final CohortAnalysisTask task;
    
    private final JdbcTemplate jdbcTemplate;
    
    public CohortAnalysisTasklet(final CohortAnalysisTask task, final JdbcTemplate jdbcTemplate) {
        this.task = task;
        this.jdbcTemplate = jdbcTemplate;
    }
    
    @Override
    public RepeatStatus execute(final StepContribution contribution, final ChunkContext chunkContext) throws Exception {
        String sql = this.analysisService.getRunCohortAnalysisSql(this.task);
    	log.debug("SQL: " + sql);
        sql = "DECLARE BEGIN \n--HERACLES\n\n--Patrick Ryan\n\n--last updated: 21 Jan 2015\n\n\n--chagnes for v4 to v5 that impact HERACLES\n\n--death :  cause_of_death_concept_id -> cause_concept_id\n--visit:  place_of_service_concept_id -> visit_concept_id\n--f/r:  associated_provider_id -> provider_id\n--\u0009prescribing_provider_id -> provider_id\n\n--remove:  disease_class_concept_id analyses\n\u0009\n--observation:  no more range_high / range_low...now from measurement\n--\u0009-options:  remove observation graphs in v5?   add new measurement?\n\u0009\n\n\n\n    --CDM_schema = omopv5_de\n   --results_schema = ohdsi\n  --cohort_schema = ohdsi\n  --cohort_table = cohort\n   --source_name = CDM_NAME\n    --smallcellcount = 0\n    --createTable = FALSE\n   --runHERACLESHeel = FALSE\n  --we support 4 or 5,   CDM_version = 5\n\n   --cohort_definition_id = \n\n--'2000002372'  1 large cohort\n--'2000003550,2000004386'     2 10k sized cohorts\n\n\n\n--list_of_analysis_ids = \n\n\n   --list of condition concepts to be used throughout\n--condition_concept_ids = \n   --list of drug concepts to be used throughout\n--drug_concept_ids = \n   --list of procedure concepts to be used throughout\n--procedure_concept_ids = \n   --list of observation concepts to be used throughout\n--observation_concept_ids = \n   --list of measurement concepts to be used throughout\n--measurement_concept_ids = \n\n\n--all: '0,1,2,3,4,5,6,7,8,9,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,200,201,202,203,204,205,206,207,208,209,210,211,220,400,401,402,403,404,405,406,407,408,409,410,411,412,413,414,415,416,417,418,419,420,500,501,502,503,504,505,506,509,510,511,512,513,514,515,600,601,602,603,604,605,606,607,608,609,610,611,612,613,614,615,616,617,618,619,620,700,701,702,703,704,705,706,707,708,709,710,711,712,713,714,715,716,717,717,718,719,720,800,801,802,803,804,805,806,807,808,809,810,811,812,813,814,815,816,817,818,819,820,900,901,902,903,904,905,906,907,908,909,910,911,912,913,914,915,916,917,918,919,920,1000,1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1011,1012,1013,1014,1015,1016,1017,1018,1019,1020,1100,1101,1102,1103,1200,1201,1202,1203,1700,1701,1800,1801,1802,1803,1804,1805,1806,1807,1808,1809,1810,1811,1812,1813,1814,1815,1816,1817,1818,1819,1820,1821,1830,1831,1840,1841,1850,1851,1860,1861,1870,1871'\n--person: '0,1,2,3,4,5,6,7,8,9'\n--observation: '101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117'\n--visits: '200,201,202,203,204,205,206,207,208,209,210,211,220'\n--condition: '400,401,402,403,404,405,406,407,408,409,410,411,412,413,414,415,416,417,418,419,420'\n--death: '500,501,502,503,504,505,506,509,510,511,512,513,514,515'\n--procedure: '600,601,602,603,604,605,606,607,608,609,610,611,612,613,614,615,616,617,618,619,620'\n--drug: '700,701,702,703,704,705,706,707,708,709,710,711,712,713,714,715,716,717,717,718,719,720'\n--observation: '800,801,802,803,804,805,806,807,808,809,810,811,812,813,814,815,816,817,818,819,820'\n--drug era: '900,901,902,903,904,905,906,907,908,909,910,911,912,913,914,915,916,917,918,919,920'\n--condition era: '1000,1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1011,1012,1013,1014,1015,1016,1017,1018,1019,1020'\n--location: '1100,1101,1102,1103'\n--care site: '1200,1201,1202,1203'\n--cohort: '1700,1701'\n--cohort-specific analyses: '1800,1801,1802,1803,1804,1805,1806,1807,1808,1809,1810,1811,1812,1813,1814,1815,1816,1817,1818,1819,1820,1821,1830,1831,1840,1841,1850,1851,1860,1861,1870,1871'\n\n\n--afranken\nEXECUTE IMMEDIATE 'ALTER SESSION SET current_schema =  ohdsi';\n\n\n--else if not createTable\ndelete from ohdsi.HERACLES_results where cohort_definition_id IN () and analysis_id IN ();\ndelete from ohdsi.HERACLES_results_dist where cohort_definition_id IN () and analysis_id IN ();\n\n\n\n--7. generate results for analysis_results\n\n\n\nBEGIN\n  EXECUTE IMMEDIATE 'TRUNCATE TABLE  HERACLES_cohort';\n  EXECUTE IMMEDIATE 'DROP TABLE  HERACLES_cohort';\nEXCEPTION\n  WHEN OTHERS THEN\n    IF SQLCODE != -942 THEN\n      RAISE;\n    END IF;\nEND;\n\nBEGIN\n  EXECUTE IMMEDIATE 'TRUNCATE TABLE  HERACLES_cohort';\n  EXECUTE IMMEDIATE 'DROP TABLE  HERACLES_cohort';\nEXCEPTION\n  WHEN OTHERS THEN\n    IF SQLCODE != -942 THEN\n      RAISE;\n    END IF;\nEND;\n\n--afranken  \nEXECUTE IMMEDIATE 'CREATE GLOBAL TEMPORARY TABLE HERACLES_cohort ON COMMIT PRESERVE ROWS AS SELECT subject_id, cohort_definition_id, cohort_start_date, cohort_end_date FROM ohdsi.cohort WHERE  cohort_definition_id in ()';  \n\n--\n-- 0\u0009Number of persons\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, 0 as analysis_id,  'CDM_NAME' as stratum_1, COUNT(distinct person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id;\n\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, 0 as analysis_id, 'CDM_NAME' as stratum_1, COUNT(distinct person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id;\n\n--\n\n\n\n\n--HERACLES Analyses on PERSON table\n\n\n--\n-- 1\u0009Number of persons\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nselect c1.cohort_definition_id, 1 as analysis_id,  COUNT(distinct person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id;\n--\n\n\n--\n-- 2\u0009Number of persons by gender\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, 2 as analysis_id,  gender_concept_id as stratum_1, COUNT(distinct person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id, GENDER_CONCEPT_ID\n;\n--\n\n\n\n--\n-- 3\u0009Number of persons by year of birth\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, 3 as analysis_id,  year_of_birth as stratum_1, COUNT(distinct person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id, YEAR_OF_BIRTH\n;\n--\n\n\n--\n-- 4\u0009Number of persons by race\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, 4 as analysis_id,  RACE_CONCEPT_ID as stratum_1, COUNT(distinct person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id, RACE_CONCEPT_ID\n;\n--\n\n\n\n--\n-- 5\u0009Number of persons by ethnicity\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, 5 as analysis_id,  ETHNICITY_CONCEPT_ID as stratum_1, COUNT(distinct person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id, ETHNICITY_CONCEPT_ID\n;\n--\n\n\n\n\n\n--\n-- 7\u0009Number of persons with invalid provider_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id, 7 as analysis_id,  COUNT(p1.person_id) as count_value\n FROM  omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n\u0009left join omopv5_de.provider pr1\n\u0009on p1.provider_id = pr1.provider_id\n  WHERE  p1.provider_id is not null\n\u0009and pr1.provider_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n\n--\n-- 8\u0009Number of persons with invalid location_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id, 8 as analysis_id,  COUNT(p1.person_id) as count_value\n FROM  omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n\u0009left join omopv5_de.location l1\n\u0009on p1.location_id = l1.location_id\n  WHERE  p1.location_id is not null\n\u0009and l1.location_id is null\ngroup by c1.cohort_definition_id\n;\n\n--\n\n\n--\n-- 9\u0009Number of persons with invalid care_site_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id, 9 as analysis_id,  COUNT(p1.person_id) as count_value\n FROM  omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n\u0009left join omopv5_de.care_site cs1\n\u0009on p1.care_site_id = cs1.care_site_id\n  WHERE  p1.care_site_id is not null\n\u0009and cs1.care_site_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n\n\n\n\n\n----/********************************************\n\n--HERACLES Analyses on OBSERVATION_PERIOD table\n\n--*********************************************/\n\n--\n-- 101\u0009Number of persons by age, with age at first observation period\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, 101 as analysis_id,   EXTRACT(YEAR FROM op1.index_date) - p1.YEAR_OF_BIRTH as stratum_1, COUNT(p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n\u0009inner join (select person_id, MIN(observation_period_start_date) as index_date from omopv5_de.OBSERVATION_PERIOD group by PERSON_ID) op1\n\u0009on p1.PERSON_ID = op1.PERSON_ID\ngroup by c1.cohort_definition_id, EXTRACT(YEAR FROM op1.index_date) - p1.YEAR_OF_BIRTH\n;\n--\n\n\n\n--\n-- 102\u0009Number of persons by gender by age, with age at first observation period\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id, 102 as analysis_id,  p1.gender_concept_id as stratum_1, EXTRACT(YEAR FROM op1.index_date) - p1.YEAR_OF_BIRTH as stratum_2, COUNT(p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n\u0009inner join (select person_id, MIN(observation_period_start_date) as index_date from omopv5_de.OBSERVATION_PERIOD group by PERSON_ID) op1\n\u0009on p1.PERSON_ID = op1.PERSON_ID\ngroup by c1.cohort_definition_id, p1.gender_concept_id, EXTRACT(YEAR FROM op1.index_date) - p1.YEAR_OF_BIRTH\n;\n--\n\n\n--\n-- 103\u0009Distribution of age at first observation period\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id, \n\u0009103 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009EXTRACT(YEAR FROM op1.index_date) - p1.YEAR_OF_BIRTH as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id order by EXTRACT(YEAR FROM op1.index_date) - p1.YEAR_OF_BIRTH))/(COUNT(EXTRACT(YEAR FROM op1.index_date) - p1.YEAR_OF_BIRTH) over (partition by c1.cohort_definition_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n\u0009inner join (select person_id, MIN(observation_period_start_date) as index_date from omopv5_de.OBSERVATION_PERIOD group by PERSON_ID) op1\n\u0009on p1.PERSON_ID = op1.PERSON_ID\n) t1\ngroup by cohort_definition_id\n;\n\n--\n\n\n\n\n--\n-- 104\u0009Distribution of age at first observation period by gender\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id, \n\u0009104 as analysis_id,\n\u0009gender_concept_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009p1.gender_concept_id,\n\u0009EXTRACT(YEAR FROM op1.index_date) - p1.YEAR_OF_BIRTH as count_value,\n\u00091.0*(row_number() over (partition by p1.gender_concept_id, c1.cohort_definition_id order by EXTRACT(YEAR FROM op1.index_date) - p1.YEAR_OF_BIRTH))/(COUNT(EXTRACT(YEAR FROM op1.index_date) - p1.YEAR_OF_BIRTH) over (partition by p1.gender_concept_id, c1.cohort_definition_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n\u0009inner join (select person_id, MIN(observation_period_start_date) as index_date from omopv5_de.OBSERVATION_PERIOD group by PERSON_ID) op1\n\u0009on p1.PERSON_ID = op1.PERSON_ID\n) t1\ngroup by cohort_definition_id, gender_concept_id\n;\n--\n\n\n\n\n--\n-- 105\u0009Length of observation (days) of first observation period\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009105 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009( op1.observation_period_end_date - op1.observation_period_start_date) as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id order by ( op1.observation_period_end_date - op1.observation_period_start_date)))/(COUNT(( op1.observation_period_end_date - op1.observation_period_start_date)) over (partition by c1.cohort_definition_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n\u0009inner join \n\u0009(select person_id, \n\u0009\u0009OBSERVATION_PERIOD_START_DATE, \n\u0009\u0009OBSERVATION_PERIOD_END_DATE, \n\u0009\u0009ROW_NUMBER() over (PARTITION by person_id order by observation_period_start_date asc) as rn1\n\u0009\u0009 from omopv5_de.OBSERVATION_PERIOD\n\u0009) op1\n\u0009on p1.PERSON_ID = op1.PERSON_ID\n\u0009where op1.rn1 = 1\n) t1\ngroup by cohort_definition_id\n;\n--\n\n\n--\n-- 106\u0009Length of observation (days) of first observation period by gender\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009106 as analysis_id,\n\u0009gender_concept_id as stratum_1,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009p1.gender_concept_id,\n\u0009( op1.observation_period_end_date - op1.observation_period_start_date) as count_value,\n\u00091.0*(row_number() over (partition by p1.gender_concept_id, c1.cohort_definition_id order by ( op1.observation_period_end_date - op1.observation_period_start_date)))/(COUNT(( op1.observation_period_end_date - op1.observation_period_start_date)) over (partition by p1.gender_concept_id, c1.cohort_definition_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n\u0009inner join \n\u0009(select person_id, \n\u0009\u0009OBSERVATION_PERIOD_START_DATE, \n\u0009\u0009OBSERVATION_PERIOD_END_DATE, \n\u0009\u0009ROW_NUMBER() over (PARTITION by person_id order by observation_period_start_date asc) as rn1\n\u0009\u0009 from omopv5_de.OBSERVATION_PERIOD\n\u0009) op1\n\u0009on p1.PERSON_ID = op1.PERSON_ID\n\u0009where op1.rn1 = 1\n) t1\ngroup by cohort_definition_id, gender_concept_id\n;\n--\n\n\n\n--\n-- 107\u0009Length of observation (days) of first observation period by age decile\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009107 as analysis_id,\n\u0009age_decile as stratum_1,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009floor((EXTRACT(YEAR FROM op1.OBSERVATION_PERIOD_START_DATE) - p1.YEAR_OF_BIRTH)/10) as age_decile,\n\u0009( op1.observation_period_end_date - op1.observation_period_start_date) as count_value,\n\u00091.0*(row_number() over (partition by floor((EXTRACT(YEAR FROM op1.OBSERVATION_PERIOD_START_DATE) - p1.YEAR_OF_BIRTH)/10), c1.cohort_definition_id order by ( op1.observation_period_end_date - op1.observation_period_start_date)))/(COUNT(( op1.observation_period_end_date - op1.observation_period_start_date)) over (partition by floor((EXTRACT(YEAR FROM op1.OBSERVATION_PERIOD_START_DATE) - p1.YEAR_OF_BIRTH)/10), c1.cohort_definition_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n\u0009inner join \n\u0009(select person_id, \n\u0009\u0009OBSERVATION_PERIOD_START_DATE, \n\u0009\u0009OBSERVATION_PERIOD_END_DATE, \n\u0009\u0009ROW_NUMBER() over (PARTITION by person_id order by observation_period_start_date asc) as rn1\n\u0009\u0009 from omopv5_de.OBSERVATION_PERIOD\n\u0009) op1\n\u0009on p1.PERSON_ID = op1.PERSON_ID\n\u0009where op1.rn1 = 1\n) t1\ngroup by cohort_definition_id, age_decile\n;\n--\n\n\n\n\n\n\n--\n-- 108\u0009Number of persons by length of observation period, in 30d increments\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nSELECT   c1.cohort_definition_id, \n\u0009108 as analysis_id,  \n\u0009floor(( op1.observation_period_end_date -  op1.observation_period_start_date)/30) as stratum_1, \n\u0009COUNT(distinct p1.person_id) as count_value\n FROM  omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n\u0009inner join \n\u0009(select person_id, \n\u0009\u0009OBSERVATION_PERIOD_START_DATE, \n\u0009\u0009OBSERVATION_PERIOD_END_DATE, \n\u0009\u0009ROW_NUMBER() over (PARTITION by person_id order by observation_period_start_date asc) as rn1\n\u0009\u0009 from omopv5_de.OBSERVATION_PERIOD\n\u0009) op1\n\u0009on p1.PERSON_ID = op1.PERSON_ID\n\u0009  WHERE  op1.rn1 = 1\ngroup by c1.cohort_definition_id, floor(( op1.observation_period_end_date -  op1.observation_period_start_date)/30)\n;\n--\n\n\n\n\n--\n-- 109\u0009Number of persons with continuous observation in each year\n-- Note: using temp table instead of nested query because this gives vastly improved performance in Oracle\n\nBEGIN\n  EXECUTE IMMEDIATE 'TRUNCATE TABLE  temp_dates';\n  EXECUTE IMMEDIATE 'DROP TABLE  temp_dates';\nEXCEPTION\n  WHEN OTHERS THEN\n    IF SQLCODE != -942 THEN\n      RAISE;\n    END IF;\nEND;\n\nEXECUTE IMMEDIATE 'CREATE GLOBAL TEMPORARY TABLE temp_dates ON COMMIT PRESERVE ROWS AS SELECT DISTINCT  EXTRACT(YEAR FROM observation_period_start_date) AS obs_year, TO_DATE(TO_CHAR(EXTRACT(YEAR FROM observation_period_start_date) ) || '01' || '01' , 'yyyymmdd') AS obs_year_start, TO_DATE(TO_CHAR(EXTRACT(YEAR FROM observation_period_start_date) ) || '12' || '31' , 'yyyymmdd') AS obs_year_end FROM omopv5_de.PERSON p1 inner join (select subject_id, cohort_definition_id as cohort_definition_id from omopv5_de.COHORT where cohort_definition_id in ()) c1 on p1.person_id = c1.subject_id inner join omopv5_de.observation_period op1 on p1.person_id = op1.person_id';\n\nINSERT INTO HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nSELECT   c1.cohort_definition_id, \n  109 AS analysis_id,  \n\u0009obs_year AS stratum_1, \n\u0009COUNT(DISTINCT p1.person_id) AS count_value\n FROM  omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id as cohort_definition_id from omopv5_de.COHORT where cohort_definition_id in ()) c1\n\u0009on p1.person_id = c1.subject_id\ninner join\n  omopv5_de.observation_period op1\n  on p1.person_id = op1.person_id,\n\u0009temp_dates\n  WHERE   \n\u0009\u0009observation_period_start_date <= obs_year_start\n\u0009AND \n\u0009\u0009observation_period_end_date >= obs_year_end\nGROUP BY \n\u0009c1.cohort_definition_id, obs_year\n;\n\nTRUNCATE TABLE temp_dates;\nDROP TABLE temp_dates;\n\n--\n\n\n--\n-- 110\u0009Number of persons with continuous observation in each month\n-- Note: using temp table instead of nested query because this gives vastly improved performance in Oracle\n\nBEGIN\n  EXECUTE IMMEDIATE 'TRUNCATE TABLE  temp_dates';\n  EXECUTE IMMEDIATE 'DROP TABLE  temp_dates';\nEXCEPTION\n  WHEN OTHERS THEN\n    IF SQLCODE != -942 THEN\n      RAISE;\n    END IF;\nEND;\n\nEXECUTE IMMEDIATE 'CREATE GLOBAL TEMPORARY TABLE temp_dates ON COMMIT PRESERVE ROWS AS SELECT DISTINCT EXTRACT(YEAR FROM observation_period_start_date)*100 + EXTRACT(MONTH FROM observation_period_start_date) AS obs_month, TO_DATE(TO_CHAR(EXTRACT(YEAR FROM observation_period_start_date) ) ||  SUBSTR('0' || TO_CHAR(EXTRACT(MONTH FROM OBSERVATION_PERIOD_START_DATE) ),- 2) || '01' , 'yyyymmdd') AS obs_month_start, (ADD_MONTHS(TO_DATE(TO_CHAR(EXTRACT(YEAR FROM observation_period_start_date) ) ||  SUBSTR('0' || TO_CHAR(EXTRACT(MONTH FROM OBSERVATION_PERIOD_START_DATE) ),- 2) || '01' , 'yyyymmdd'), 1) + -1) AS obs_month_end FROM omopv5_de.PERSON p1 inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1 on p1.person_id = c1.subject_id inner join omopv5_de.observation_period op1 on p1.person_id = op1.person_id';\n\n\nINSERT INTO HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nSELECT   c1.cohort_definition_id, \n  110 AS analysis_id, \n\u0009obs_month AS stratum_1, \n\u0009COUNT(DISTINCT p1.person_id) AS count_value\n FROM  omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ninner join\n  omopv5_de.observation_period op1\n  on p1.person_id = op1.person_id,\n\u0009temp_Dates\n  WHERE  \n\u0009\u0009observation_period_start_date <= obs_month_start\n\u0009AND \n\u0009\u0009observation_period_end_date >= obs_month_end\nGROUP BY \n\u0009c1.cohort_definition_id, obs_month\n;\n\nTRUNCATE TABLE temp_dates;\nDROP TABLE temp_dates;\n\n--\n\n\n\n--\n-- 111\u0009Number of persons by observation period start month\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009111 as analysis_id, \n\u0009EXTRACT(YEAR FROM observation_period_start_date)*100 + EXTRACT(MONTH FROM OBSERVATION_PERIOD_START_DATE) as stratum_1, \n\u0009COUNT(distinct op1.PERSON_ID) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ninner join\n  omopv5_de.observation_period op1\n  on p1.person_id = op1.person_id\ngroup by c1.cohort_definition_id, EXTRACT(YEAR FROM observation_period_start_date)*100 + EXTRACT(MONTH FROM OBSERVATION_PERIOD_START_DATE)\n;\n--\n\n\n\n--\n-- 112\u0009Number of persons by observation period end month\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009112 as analysis_id,  \n\u0009EXTRACT(YEAR FROM observation_period_end_date)*100 + EXTRACT(MONTH FROM observation_period_end_date) as stratum_1, \n\u0009COUNT(distinct op1.PERSON_ID) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ninner join\n  omopv5_de.observation_period op1\n  on p1.person_id = op1.person_id\ngroup by c1.cohort_definition_id, EXTRACT(YEAR FROM observation_period_end_date)*100 + EXTRACT(MONTH FROM observation_period_end_date)\n;\n--\n\n\n--\n-- 113\u0009Number of persons by number of observation periods\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect cohort_definition_id, \n\u0009113 as analysis_id,  \n\u0009op1.num_periods as stratum_1, COUNT(distinct op1.PERSON_ID) as count_value\nfrom\n\u0009(select cohort_definition_id, person_id, COUNT(OBSERVATION_period_start_date) as num_periods \n\u0009\u0009from omopv5_de.OBSERVATION_PERIOD op0\n\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009\u0009on op0.person_id = c1.subject_id\n\u0009\u0009group by cohort_definition_id, PERSON_ID) op1\ngroup by cohort_definition_id, op1.num_periods\n;\n--\n\n--\n-- 114\u0009Number of persons with observation period before year-of-birth\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   cohort_definition_id,\n\u0009114 as analysis_id,  \n\u0009COUNT(distinct p1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.PERSON p1\n\u0009inner join (select cohort_definition_id, person_id, MIN(EXTRACT(YEAR FROM OBSERVATION_period_start_date)) as first_obs_year \n\u0009\u0009from omopv5_de.OBSERVATION_PERIOD op0\n\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009\u0009on op0.person_id = c1.subject_id\n\u0009\u0009group by cohort_definition_id, PERSON_ID) op1\n\u0009on p1.person_id = op1.person_id\n  WHERE  p1.year_of_birth > op1.first_obs_year\ngroup by cohort_definition_id\n;\n--\n\n--\n-- 115\u0009Number of persons with observation period end < start\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009115 as analysis_id,  \n\u0009COUNT(op1.PERSON_ID) as count_value\n FROM  omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ninner join\n  omopv5_de.observation_period op1\n  on p1.person_id = op1.person_id\n  WHERE  op1.observation_period_end_date < op1.observation_period_start_date\ngroup by c1.cohort_definition_id\n;\n--\n\n\n\n--\n-- 116\u0009Number of persons with at least one day of observation in each year by gender and age decile\n-- Note: using temp table instead of nested query because this gives vastly improved performance in Oracle\n\nBEGIN\n  EXECUTE IMMEDIATE 'TRUNCATE TABLE  temp_dates';\n  EXECUTE IMMEDIATE 'DROP TABLE  temp_dates';\nEXCEPTION\n  WHEN OTHERS THEN\n    IF SQLCODE != -942 THEN\n      RAISE;\n    END IF;\nEND;\n\nEXECUTE IMMEDIATE 'CREATE GLOBAL TEMPORARY TABLE temp_dates ON COMMIT PRESERVE ROWS AS SELECT distinct EXTRACT(YEAR FROM observation_period_start_date) as obs_year FROM omopv5_de.PERSON p1 inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1 on p1.person_id = c1.subject_id inner join omopv5_de.observation_period op1 on p1.person_id = op1.person_id';\n\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, stratum_3, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009116 as analysis_id,  \n\u0009t1.obs_year as stratum_1, \n\u0009p1.gender_concept_id as stratum_2,\n\u0009floor((t1.obs_year - p1.year_of_birth)/10) as stratum_3,\n\u0009COUNT(distinct p1.PERSON_ID) as count_value\n FROM  omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ninner join\n  omopv5_de.observation_period op1\n  on p1.person_id = op1.person_id\n\u0009,\n\u0009temp_dates t1 \n  WHERE  EXTRACT(YEAR FROM op1.OBSERVATION_PERIOD_START_DATE) <= t1.obs_year\n\u0009and EXTRACT(YEAR FROM op1.OBSERVATION_PERIOD_END_DATE) >= t1.obs_year\ngroup by c1.cohort_definition_id,\n\u0009t1.obs_year,\n\u0009p1.gender_concept_id,\n\u0009floor((t1.obs_year - p1.year_of_birth)/10)\n;\n\nTRUNCATE TABLE temp_dates;\nDROP TABLE temp_dates;\n\n--\n\n\n--\n-- 117\u0009Number of persons with at least one day of observation in each year by gender and age decile\n-- Note: using temp table instead of nested query because this gives vastly improved performance in Oracle\n\nBEGIN\n  EXECUTE IMMEDIATE 'TRUNCATE TABLE  temp_dates';\n  EXECUTE IMMEDIATE 'DROP TABLE  temp_dates';\nEXCEPTION\n  WHEN OTHERS THEN\n    IF SQLCODE != -942 THEN\n      RAISE;\n    END IF;\nEND;\n\nEXECUTE IMMEDIATE 'CREATE GLOBAL TEMPORARY TABLE temp_dates ON COMMIT PRESERVE ROWS AS SELECT distinct EXTRACT(YEAR FROM observation_period_start_date)*100 + EXTRACT(MONTH FROM observation_period_start_date)  as obs_month FROM omopv5_de.PERSON p1 inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1 on p1.person_id = c1.subject_id inner join omopv5_de.observation_period op1 on p1.person_id = op1.person_id';\n\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nSELECT   c1.cohort_definition_id, \n\u0009117 as analysis_id,  \n\u0009t1.obs_month as stratum_1,\n\u0009COUNT(distinct op1.PERSON_ID) as count_value\n FROM  omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ninner join\n  omopv5_de.observation_period op1\n  on p1.person_id = op1.person_id,\n\u0009temp_dates t1 \n  WHERE  EXTRACT(YEAR FROM observation_period_start_date)*100 + EXTRACT(MONTH FROM observation_period_start_date) <= t1.obs_month\n\u0009and EXTRACT(YEAR FROM observation_period_end_date)*100 + EXTRACT(MONTH FROM observation_period_end_date) >= t1.obs_month\ngroup by c1.cohort_definition_id, t1.obs_month\n;\n\nTRUNCATE TABLE temp_dates;\nDROP TABLE temp_dates;\n\n--\n\n\n--/********************************************\n\n--HERACLES Analyses on VISIT_OCCURRENCE table\n\n--*********************************************/\n\n\n--\n-- 200\u0009Number of persons with at least one visit occurrence, by visit_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, 200 as analysis_id,\n\u0009--\n\u0009--\n\u0009vo1.visit_CONCEPT_ID as stratum_1,\n\u0009--\n\u0009COUNT(distinct vo1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.visit_occurrence vo1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on vo1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id,\n\u0009--\n\u0009--\n\u0009vo1.visit_CONCEPT_ID\n\u0009--\n;\n--\n\n\n--\n-- 201\u0009Number of visit occurrence records, by visit_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, 201 as analysis_id, \n\u0009--\n\u0009--\n\u0009vo1.visit_CONCEPT_ID as stratum_1,\n\u0009--\n\u0009COUNT(vo1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.visit_occurrence vo1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on vo1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id,\n\u0009--\n\u0009--\n\u0009vo1.visit_CONCEPT_ID\n\u0009--\n;\n--\n\n\n\n--\n-- 202\u0009Number of persons by visit occurrence start month, by visit_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id,\n\u0009202 as analysis_id,   \n\u0009--\n\u0009--\n\u0009vo1.visit_CONCEPT_ID as stratum_1,\n\u0009--\n\u0009EXTRACT(YEAR FROM visit_start_date)*100 + EXTRACT(MONTH FROM visit_start_date) as stratum_2, \n\u0009COUNT(distinct PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.visit_occurrence vo1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on vo1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id,\n\u0009--\n\u0009--\n\u0009vo1.visit_CONCEPT_ID,\n\u0009--\n\u0009EXTRACT(YEAR FROM visit_start_date)*100 + EXTRACT(MONTH FROM visit_start_date)\n;\n--\n\n\n\n--\n-- 203\u0009Number of distinct visit occurrence concepts per person\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009203 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect cohort_definition_id,\n\u0009num_visits as count_value,\n\u00091.0*(row_number() over (partition by cohort_definition_id order by num_visits))/(COUNT(num_visits) over (partition by cohort_definition_id)+1) as p1\nfrom\n\u0009(\n\u0009select c1.cohort_definition_id, vo1.person_id, \n\u0009\u0009--\n\u0009\u0009--\n\u0009\u0009COUNT(distinct vo1.visit_concept_id) as num_visits\n\u0009\u0009--\n\u0009from\n\u0009omopv5_de.visit_occurrence vo1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on vo1.person_id = c1.subject_id\n\u0009group by c1.cohort_definition_id, vo1.person_id\n\u0009) t0\n) t1\ngroup by cohort_definition_id\n;\n--\n\n\n\n--\n-- 204\u0009Number of persons with at least one visit occurrence, by visit_concept_id by calendar year by gender by age decile\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, stratum_3, stratum_4, count_value)\nselect c1.cohort_definition_id,\n\u0009204 as analysis_id,   \n\u0009--\n\u0009--\n\u0009vo1.visit_CONCEPT_ID as stratum_1,\n\u0009--\n\u0009EXTRACT(YEAR FROM visit_start_date) as stratum_2,\n\u0009p1.gender_concept_id as stratum_3,\n\u0009floor((EXTRACT(YEAR FROM visit_start_date) - p1.year_of_birth)/10) as stratum_4, \n\u0009COUNT(distinct p1.PERSON_ID) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ninner join\nomopv5_de.visit_occurrence vo1\non p1.person_id = vo1.person_id\ngroup by c1.cohort_definition_id,\n\u0009--\n\u0009--\n\u0009vo1.visit_CONCEPT_ID,\n\u0009--\n\u0009EXTRACT(YEAR FROM visit_start_date),\n\u0009p1.gender_concept_id,\n\u0009floor((EXTRACT(YEAR FROM visit_start_date) - p1.year_of_birth)/10)\n;\n--\n\n\n\n\n\n--\n-- 206\u0009Distribution of age by visit_concept_id\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009206 as analysis_id,\n\u0009  visit_CONCEPT_ID  as stratum_1,\n\u0009gender_concept_id as stratum_2,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009--\n\u0009--\n\u0009vo1.visit_CONCEPT_ID,\n\u0009--\n\u0009p1.gender_concept_id,\n\u0009vo1.visit_start_year - p1.year_of_birth as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id,   vo1.visit_CONCEPT_ID , p1.gender_concept_id order by vo1.visit_start_year - p1.year_of_birth))/(COUNT(vo1.visit_start_year - p1.year_of_birth) over (partition by c1.cohort_definition_id,   vo1.visit_CONCEPT_ID , p1.gender_concept_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ninner join\n(select vo1.person_id, \n\u0009--\n\u0009--\n\u0009vo1.visit_CONCEPT_ID,\n\u0009-- \n\u0009min(EXTRACT(YEAR FROM vo1.visit_start_date)) as visit_start_year\nfrom omopv5_de.visit_occurrence vo1\ngroup by person_id, \n\u0009--\n\u0009--\n\u0009vo1.visit_CONCEPT_ID\n\u0009--place_of_service_concept_id\n) vo1\non p1.person_id = vo1.person_id\n) t1\ngroup by cohort_definition_id, \n\u0009  visit_CONCEPT_ID , \n\u0009gender_concept_id\n;\n--\n\n\n--\n--207\u0009Number of visit records with invalid person_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009207 as analysis_id,  \n\u0009COUNT(vo1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.visit_occurrence vo1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on vo1.person_id = c1.subject_id\n\u0009left join omopv5_de.PERSON p1\n\u0009on p1.person_id = vo1.person_id\n  WHERE  p1.person_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n--208\u0009Number of visit records outside valid observation period\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   cohort_definition_id,\n\u0009208 as analysis_id,  \n\u0009COUNT(vo1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.visit_occurrence vo1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on vo1.person_id = c1.subject_id\n\u0009left join omopv5_de.OBSERVATION_PERIOD op1\n\u0009on op1.person_id = vo1.person_id\n\u0009and vo1.visit_start_date >= op1.observation_period_start_date\n\u0009and vo1.visit_start_date <= op1.observation_period_end_date\n  WHERE  op1.person_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n--\n--209\u0009Number of visit records with end date < start date\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009209 as analysis_id,  \n\u0009COUNT(vo1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.visit_occurrence vo1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on vo1.person_id = c1.subject_id\n  WHERE  visit_end_date < visit_start_date\ngroup by c1.cohort_definition_id\n;\n--\n\n--\n--210\u0009Number of visit records with invalid care_site_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009210 as analysis_id,  \n\u0009COUNT(vo1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.visit_occurrence vo1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on vo1.person_id = c1.subject_id\n\u0009left join omopv5_de.care_site cs1\n\u0009on vo1.care_site_id = cs1.care_site_id\n  WHERE  vo1.care_site_id is not null\n\u0009and cs1.care_site_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 211\u0009Distribution of length of stay by visit_concept_id\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009211 as analysis_id,\n\u0009--\n\u0009--\n\u0009visit_CONCEPT_ID\n\u0009--\n\u0009as stratum_1,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009--\n\u0009--\n\u0009vo1.visit_CONCEPT_ID,\n\u0009--\n\u0009(visit_end_date - visit_start_date) as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id,   vo1.visit_CONCEPT_ID  order by (visit_end_date - visit_start_date)))/(COUNT((visit_end_date - visit_start_date)) over (partition by c1.cohort_definition_id,   vo1.visit_CONCEPT_ID )+1) as p1\nfrom omopv5_de.visit_occurrence vo1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on vo1.person_id = c1.subject_id\n) t1\ngroup by cohort_definition_id, \n\u0009--\n\u0009--\n\u0009visit_CONCEPT_ID\n\u0009--\n;\n--\n\n\n\n\n\n--\n-- 220\u0009Number of visit occurrence records by condition occurrence start month\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009220 as analysis_id,   \n\u0009EXTRACT(YEAR FROM visit_start_date)*100 + EXTRACT(MONTH FROM visit_start_date) as stratum_1, \n\u0009COUNT(PERSON_ID) as count_value\nfrom\nomopv5_de.visit_occurrence vo1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on vo1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id, EXTRACT(YEAR FROM visit_start_date)*100 + EXTRACT(MONTH FROM visit_start_date)\n;\n--\n\n\n\n\n\n--/********************************************\n\n--HERACLES Analyses on CONDITION_OCCURRENCE table\n\n--*********************************************/\n\n\n--\n-- 400\u0009Number of persons with at least one condition occurrence, by condition_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009400 as analysis_id, \n\u0009co1.condition_CONCEPT_ID as stratum_1,\n\u0009COUNT(distinct co1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.condition_occurrence co1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on co1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009co1.condition_CONCEPT_ID\n;\n--\n\n\n--\n-- 401\u0009Number of condition occurrence records, by condition_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009401 as analysis_id, \n\u0009co1.condition_CONCEPT_ID as stratum_1,\n\u0009COUNT(co1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.condition_occurrence co1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on co1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009co1.condition_CONCEPT_ID\n;\n--\n\n\n\n--\n-- 402\u0009Number of persons by condition occurrence start month, by condition_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id,\n\u0009402 as analysis_id,   \n\u0009co1.condition_concept_id as stratum_1,\n\u0009EXTRACT(YEAR FROM condition_start_date)*100 + EXTRACT(MONTH FROM condition_start_date) as stratum_2, \n\u0009COUNT(distinct PERSON_ID) as count_value\nfrom\nomopv5_de.condition_occurrence co1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on co1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009co1.condition_concept_id, \n\u0009EXTRACT(YEAR FROM condition_start_date)*100 + EXTRACT(MONTH FROM condition_start_date)\n;\n--\n\n\n\n--\n-- 403\u0009Number of distinct condition occurrence concepts per person\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009403 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect cohort_definition_id, \n\u0009num_conditions as count_value,\n\u00091.0*(row_number() over (partition by cohort_definition_id order by num_conditions))/(COUNT(num_conditions) over (partition by cohort_definition_id)+1) as p1\nfrom\n\u0009(\n\u0009select c1.cohort_definition_id, co1.person_id, COUNT(distinct co1.condition_concept_id) as num_conditions\n\u0009from\n\u0009omopv5_de.condition_occurrence co1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on co1.person_id = c1.subject_id\n\u0009group by c1.cohort_definition_id, co1.person_id\n\u0009) t0\n) t1\ngroup by cohort_definition_id\n;\n--\n\n\n\n--\n-- 404\u0009Number of persons with at least one condition occurrence, by condition_concept_id by calendar year by gender by age decile\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, stratum_3, stratum_4, count_value)\nselect c1.cohort_definition_id,\n\u0009404 as analysis_id,   \n\u0009co1.condition_concept_id as stratum_1,\n\u0009EXTRACT(YEAR FROM condition_start_date) as stratum_2,\n\u0009p1.gender_concept_id as stratum_3,\n\u0009floor((EXTRACT(YEAR FROM condition_start_date) - p1.year_of_birth)/10) as stratum_4, \n\u0009COUNT(distinct p1.PERSON_ID) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ninner join\nomopv5_de.condition_occurrence co1\non p1.person_id = co1.person_id\n--\ngroup by c1.cohort_definition_id,\n\u0009co1.condition_concept_id, \n\u0009EXTRACT(YEAR FROM condition_start_date),\n\u0009p1.gender_concept_id,\n\u0009floor((EXTRACT(YEAR FROM condition_start_date) - p1.year_of_birth)/10)\n;\n--\n\n--\n-- 405\u0009Number of condition occurrence records, by condition_concept_id by condition_type_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id,\n\u0009405 as analysis_id, \n\u0009co1.condition_CONCEPT_ID as stratum_1,\n\u0009co1.condition_type_concept_id as stratum_2,\n\u0009COUNT(co1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.condition_occurrence co1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on co1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009co1.condition_CONCEPT_ID,\u0009\n\u0009co1.condition_type_concept_id\n;\n--\n\n\n\n--\n-- 406\u0009Distribution of age by condition_concept_id\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009406 as analysis_id,\n\u0009condition_concept_id as stratum_1,\n\u0009gender_concept_id as stratum_2,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009co1.condition_concept_id,\n\u0009p1.gender_concept_id,\n\u0009co1.condition_start_year - p1.year_of_birth as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id, co1.condition_concept_id, p1.gender_concept_id order by co1.condition_start_year - p1.year_of_birth))/(COUNT(co1.condition_start_year - p1.year_of_birth) over (partition by c1.cohort_definition_id, co1.condition_concept_id, p1.gender_concept_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ninner join\n(select person_id, condition_concept_id, min(EXTRACT(YEAR FROM condition_start_date)) as condition_start_year\nfrom omopv5_de.condition_occurrence\n--\ngroup by person_id, condition_concept_id\n) co1\non p1.person_id = co1.person_id\n) t1\ngroup by cohort_definition_id, condition_concept_id, gender_concept_id\n;\n--\n\n\n\n\n\n\n--\n-- 409\u0009Number of condition occurrence records with invalid person_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id, \n\u0009409 as analysis_id,  \n\u0009COUNT(co1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.condition_occurrence co1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on co1.person_id = c1.subject_id\n\u0009left join omopv5_de.PERSON p1\n\u0009on p1.person_id = co1.person_id\n  WHERE  p1.person_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 410\u0009Number of condition occurrence records outside valid observation period\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009410 as analysis_id,  \n\u0009COUNT(co1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.condition_occurrence co1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on co1.person_id = c1.subject_id\n\u0009left join omopv5_de.OBSERVATION_PERIOD op1\n\u0009on op1.person_id = co1.person_id\n\u0009and co1.condition_start_date >= op1.observation_period_start_date\n\u0009and co1.condition_start_date <= op1.observation_period_end_date\n  WHERE  op1.person_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 411\u0009Number of condition occurrence records with end date < start date\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009411 as analysis_id,  \n\u0009COUNT(co1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.condition_occurrence co1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on co1.person_id = c1.subject_id\n  WHERE  co1.condition_end_date < co1.condition_start_date\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 412\u0009Number of condition occurrence records with invalid provider_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009412 as analysis_id,  \n\u0009COUNT(co1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.condition_occurrence co1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on co1.person_id = c1.subject_id\n\u0009left join omopv5_de.provider p1\n\u0009on p1.provider_id =     co1.provider_id  \n  WHERE    co1.provider_id   is not null\n\u0009and p1.provider_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n--\n-- 413\u0009Number of condition occurrence records with invalid visit_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009413 as analysis_id,  \n\u0009COUNT(co1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.condition_occurrence co1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on co1.person_id = c1.subject_id\n\u0009left join omopv5_de.visit_occurrence vo1\n\u0009on co1.visit_occurrence_id = vo1.visit_occurrence_id\n  WHERE  co1.visit_occurrence_id is not null\n\u0009and vo1.visit_occurrence_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n--\n-- 420\u0009Number of condition occurrence records by condition occurrence start month\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009420 as analysis_id,   \n\u0009EXTRACT(YEAR FROM condition_start_date)*100 + EXTRACT(MONTH FROM condition_start_date) as stratum_1, \n\u0009COUNT(PERSON_ID) as count_value\nfrom\nomopv5_de.condition_occurrence co1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on co1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id, \n\u0009EXTRACT(YEAR FROM condition_start_date)*100 + EXTRACT(MONTH FROM condition_start_date)\n;\n--\n\n\n\n--/********************************************\n\n--HERACLES Analyses on DEATH table\n\n--*********************************************/\n\n\n\n--\n-- 500\u0009Number of persons with death, by cause_of_death_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009500 as analysis_id, \n\u0009  d1.cause_CONCEPT_ID  \u0009 as stratum_1,\n\u0009COUNT(distinct d1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.death d1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on d1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id,\n\u0009  d1.cause_CONCEPT_ID  \n;\n--\n\n\n--\n-- 501\u0009Number of records of death, by cause_of_death_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009501 as analysis_id, \n\u0009  d1.cause_CONCEPT_ID   as stratum_1,\n\u0009COUNT(d1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.death d1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on d1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id, \n\u0009  d1.cause_CONCEPT_ID  \n;\n--\n\n\n\n--\n-- 502\u0009Number of persons by condition occurrence start month\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009502 as analysis_id,   \n\u0009EXTRACT(YEAR FROM death_date)*100 + EXTRACT(MONTH FROM death_date) as stratum_1, \n\u0009COUNT(distinct PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.death d1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on d1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id,\n\u0009EXTRACT(YEAR FROM death_date)*100 + EXTRACT(MONTH FROM death_date)\n;\n--\n\n\n\n--\n-- 504\u0009Number of persons with a death, by calendar year by gender by age decile\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, stratum_3, count_value)\nselect c1.cohort_definition_id,\n\u0009504 as analysis_id,   \n\u0009EXTRACT(YEAR FROM death_date) as stratum_1,\n\u0009p1.gender_concept_id as stratum_2,\n\u0009floor((EXTRACT(YEAR FROM death_date) - p1.year_of_birth)/10) as stratum_3, \n\u0009COUNT(distinct p1.PERSON_ID) as count_value\nfrom omopv5_de.PERSON p1\ninner join\nomopv5_de.death d1\non p1.person_id = d1.person_id\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on d1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id,\n\u0009EXTRACT(YEAR FROM death_date),\n\u0009p1.gender_concept_id,\n\u0009floor((EXTRACT(YEAR FROM death_date) - p1.year_of_birth)/10)\n;\n--\n\n--\n-- 505\u0009Number of death records, by death_type_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009505 as analysis_id, \n\u0009death_type_concept_id as stratum_1,\n\u0009COUNT(PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.death d1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on d1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id,\n\u0009death_type_concept_id\n;\n--\n\n\n\n--\n-- 506\u0009Distribution of age by condition_concept_id\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009506 as analysis_id,\n\u0009gender_concept_id as stratum_1,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009p1.gender_concept_id,\n\u0009d1.death_year - p1.year_of_birth as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id, p1.gender_concept_id order by d1.death_year - p1.year_of_birth))/(COUNT(d1.death_year - p1.year_of_birth) over (partition by c1.cohort_definition_id, p1.gender_concept_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ninner join\n(select person_id, min(EXTRACT(YEAR FROM death_date)) as death_year\nfrom omopv5_de.death\ngroup by person_id\n) d1\non p1.person_id = d1.person_id\n) t1\ngroup by cohort_definition_id, gender_concept_id\n;\n--\n\n\n\n--\n-- 509\u0009Number of death records with invalid person_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id, 509 as analysis_id, \n\u0009COUNT(d1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.death d1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on d1.person_id = c1.subject_id\n\u0009\u0009left join omopv5_de.PERSON p1\n\u0009\u0009on d1.person_id = p1.person_id\n  WHERE  p1.person_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n\n--\n-- 510\u0009Number of death records outside valid observation period\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009510 as analysis_id, \n\u0009COUNT(d1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.death d1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on d1.person_id = c1.subject_id\n\u0009\u0009left join omopv5_de.OBSERVATION_PERIOD op1\n\u0009\u0009on d1.person_id = op1.person_id\n\u0009\u0009and d1.death_date >= op1.observation_period_start_date\n\u0009\u0009and d1.death_date <= op1.observation_period_end_date\n  WHERE  op1.person_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 511\u0009Distribution of time from death to last condition\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009511 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009( t0.max_date - d1.death_date) as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id order by ( t0.max_date - d1.death_date)))/(COUNT(( t0.max_date - d1.death_date)) over (partition by c1.cohort_definition_id)+1) as p1\nfrom omopv5_de.death d1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on d1.person_id = c1.subject_id\n\u0009inner join\n\u0009(\n\u0009\u0009select person_id, max(condition_start_date) as max_date\n\u0009\u0009from omopv5_de.condition_occurrence co1\n\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009\u0009on co1.person_id = c1.subject_id\n\u0009\u0009group by person_id\n\u0009) t0\n\u0009on d1.person_id = t0.person_id\n) t1\ngroup by cohort_definition_id\n;\n--\n\n\n--\n-- 512\u0009Distribution of time from death to last drug\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009512 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009( t0.max_date - d1.death_date) as count_value,\n\u00091.0*(row_number() over (order by c1.cohort_definition_id, ( t0.max_date - d1.death_date)))/(COUNT(( t0.max_date - d1.death_date)) over (partition by c1.cohort_definition_id)+1) as p1\nfrom omopv5_de.death d1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on d1.person_id = c1.subject_id\n\u0009inner join\n\u0009(\n\u0009\u0009select person_id, max(drug_exposure_start_date) as max_date\n\u0009\u0009from omopv5_de.drug_exposure de1\n\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009\u0009on de1.person_id = c1.subject_id\n\u0009\u0009group by person_id\n\u0009) t0\n\u0009on d1.person_id = t0.person_id\n) t1\ngroup by cohort_definition_id\n;\n--\n\n\n--\n-- 513\u0009Distribution of time from death to last visit\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009513 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009( t0.max_date - d1.death_date) as count_value,\n\u00091.0*(row_number() over (partition by cohort_definition_id order by ( t0.max_date - d1.death_date)))/(COUNT(( t0.max_date - d1.death_date)) over (partition by cohort_definition_id)+1) as p1\nfrom omopv5_de.death d1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on d1.person_id = c1.subject_id\n\u0009inner join\n\u0009(\n\u0009\u0009select person_id, max(visit_start_date) as max_date\n\u0009\u0009from omopv5_de.visit_occurrence vo1\n\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009\u0009on vo1.person_id = c1.subject_id\n\u0009\u0009group by person_id\n\u0009) t0\n\u0009on d1.person_id = t0.person_id\n) t1\ngroup by cohort_definition_id\n;\n--\n\n\n--\n-- 514\u0009Distribution of time from death to last procedure\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009514 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009( t0.max_date - d1.death_date) as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id order by ( t0.max_date - d1.death_date)))/(COUNT(( t0.max_date - d1.death_date)) over (partition by cohort_definition_id)+1) as p1\nfrom omopv5_de.death d1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on d1.person_id = c1.subject_id\n\u0009inner join\n\u0009(\n\u0009\u0009select person_id, max(procedure_date) as max_date\n\u0009\u0009from omopv5_de.procedure_occurrence po1\n\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009\u0009on po1.person_id = c1.subject_id\n\u0009\u0009group by person_id\n\u0009) t0\n\u0009on d1.person_id = t0.person_id\n) t1\ngroup by cohort_definition_id\n;\n--\n\n\n--\n-- 515\u0009Distribution of time from death to last observation\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009515 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009( t0.max_date - d1.death_date) as count_value,\n\u00091.0*(row_number() over (partition by cohort_definition_id order by ( t0.max_date - d1.death_date)))/(COUNT(( t0.max_date - d1.death_date)) over (partition by cohort_definition_id)+1) as p1\nfrom omopv5_de.death d1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on d1.person_id = c1.subject_id\n\u0009inner join\n\u0009(\n\u0009\u0009select person_id, max(observation_date) as max_date\n\u0009\u0009from omopv5_de.observation o1\n\u0009\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009\u0009on o1.person_id = c1.subject_id\n\u0009\u0009group by person_id\n\u0009) t0\n\u0009on d1.person_id = t0.person_id\n) t1\ngroup by cohort_definition_id\n;\n--\n\n\n\n--/********************************************\n\n--HERACLES Analyses on PROCEDURE_OCCURRENCE table\n\n--*********************************************/\n\n\n\n--\n-- 600\u0009Number of persons with at least one procedure occurrence, by procedure_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009600 as analysis_id, \n\u0009po1.procedure_CONCEPT_ID as stratum_1,\n\u0009COUNT(distinct po1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.procedure_occurrence po1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on po1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009po1.procedure_CONCEPT_ID\n;\n--\n\n\n--\n-- 601\u0009Number of procedure occurrence records, by procedure_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009601 as analysis_id, \n\u0009po1.procedure_CONCEPT_ID as stratum_1,\n\u0009COUNT(po1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.procedure_occurrence po1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on po1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009po1.procedure_CONCEPT_ID\n;\n--\n\n\n\n--\n-- 602\u0009Number of persons by procedure occurrence start month, by procedure_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id,\n\u0009602 as analysis_id,   \n\u0009po1.procedure_concept_id as stratum_1,\n\u0009EXTRACT(YEAR FROM procedure_date)*100 + EXTRACT(MONTH FROM procedure_date) as stratum_2, \n\u0009COUNT(distinct PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.procedure_occurrence po1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on po1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009po1.procedure_concept_id, \n\u0009EXTRACT(YEAR FROM procedure_date)*100 + EXTRACT(MONTH FROM procedure_date)\n;\n--\n\n\n\n--\n-- 603\u0009Number of distinct procedure occurrence concepts per person\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009603 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect cohort_definition_id,\n\u0009num_procedures as count_value,\n\u00091.0*(row_number() over (partition by cohort_definition_id order by num_procedures))/(COUNT(num_procedures) over (partition by cohort_definition_id)+1) as p1\nfrom\n\u0009(\n\u0009select c1.cohort_definition_id, po1.person_id, COUNT(distinct po1.procedure_concept_id) as num_procedures\n\u0009from\n\u0009omopv5_de.procedure_occurrence po1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on po1.person_id = c1.subject_id\n\u0009group by c1.cohort_definition_id, po1.person_id\n\u0009) t0\n) t1\ngroup by cohort_definition_id\n;\n--\n\n\n\n--\n-- 604\u0009Number of persons with at least one procedure occurrence, by procedure_concept_id by calendar year by gender by age decile\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, stratum_3, stratum_4, count_value)\nselect c1.cohort_definition_id,\n\u0009604 as analysis_id,   \n\u0009po1.procedure_concept_id as stratum_1,\n\u0009EXTRACT(YEAR FROM procedure_date) as stratum_2,\n\u0009p1.gender_concept_id as stratum_3,\n\u0009floor((EXTRACT(YEAR FROM procedure_date) - p1.year_of_birth)/10) as stratum_4, \n\u0009COUNT(distinct p1.PERSON_ID) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ninner join\nomopv5_de.procedure_occurrence po1\non p1.person_id = po1.person_id\n--\ngroup by c1.cohort_definition_id,\n\u0009po1.procedure_concept_id, \n\u0009EXTRACT(YEAR FROM procedure_date),\n\u0009p1.gender_concept_id,\n\u0009floor((EXTRACT(YEAR FROM procedure_date) - p1.year_of_birth)/10)\n;\n--\n\n--\n-- 605\u0009Number of procedure occurrence records, by procedure_concept_id by procedure_type_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id,\n\u0009605 as analysis_id, \n\u0009po1.procedure_CONCEPT_ID as stratum_1,\n\u0009po1.procedure_type_concept_id as stratum_2,\n\u0009COUNT(po1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.procedure_occurrence po1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on po1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009po1.procedure_CONCEPT_ID,\u0009\n\u0009po1.procedure_type_concept_id\n;\n--\n\n\n\n--\n-- 606\u0009Distribution of age by procedure_concept_id\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009606 as analysis_id,\n\u0009procedure_concept_id as stratum_1,\n\u0009gender_concept_id as stratum_2,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009po1.procedure_concept_id,\n\u0009p1.gender_concept_id,\n\u0009po1.procedure_start_year - p1.year_of_birth as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id, po1.procedure_concept_id, p1.gender_concept_id order by po1.procedure_start_year - p1.year_of_birth))/(COUNT(po1.procedure_start_year - p1.year_of_birth) over (partition by c1.cohort_definition_id, po1.procedure_concept_id, p1.gender_concept_id)+1) as p1\nfrom omopv5_de.PERSON p1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on p1.person_id = c1.subject_id\ninner join\n(select person_id, procedure_concept_id, min(EXTRACT(YEAR FROM procedure_date)) as procedure_start_year\nfrom omopv5_de.procedure_occurrence po1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on po1.person_id = c1.subject_id\n--\ngroup by person_id, procedure_concept_id\n) po1\non p1.person_id = po1.person_id\n) t1\ngroup by cohort_definition_id, procedure_concept_id, gender_concept_id\n;\n--\n\n\n\n\n\n\n\n--\n-- 609\u0009Number of procedure occurrence records with invalid person_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009609 as analysis_id,  \n\u0009COUNT(po1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.procedure_occurrence po1\n\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on po1.person_id = c1.subject_id\n\u0009left join omopv5_de.PERSON p1\n\u0009on p1.person_id = po1.person_id\n  WHERE  p1.person_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 610\u0009Number of procedure occurrence records outside valid observation period\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009610 as analysis_id,  \n\u0009COUNT(po1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.procedure_occurrence po1\n\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on po1.person_id = c1.subject_id\n\u0009left join omopv5_de.OBSERVATION_PERIOD op1\n\u0009on op1.person_id = po1.person_id\n\u0009and po1.procedure_date >= op1.observation_period_start_date\n\u0009and po1.procedure_date <= op1.observation_period_end_date\n  WHERE  op1.person_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n\n--\n-- 612\u0009Number of procedure occurrence records with invalid provider_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009612 as analysis_id,  \n\u0009COUNT(po1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.procedure_occurrence po1\n\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on po1.person_id = c1.subject_id\n\u0009left join omopv5_de.provider p1\n\u0009on p1.provider_id =   po1.provider_id  \n  WHERE    po1.provider_id   is not null\n\u0009and p1.provider_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n--\n-- 613\u0009Number of procedure occurrence records with invalid visit_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009613 as analysis_id,  \n\u0009COUNT(po1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.procedure_occurrence po1\n\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on po1.person_id = c1.subject_id\n\u0009left join omopv5_de.visit_occurrence vo1\n\u0009on po1.visit_occurrence_id = vo1.visit_occurrence_id\n  WHERE  po1.visit_occurrence_id is not null\n\u0009and vo1.visit_occurrence_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 620\u0009Number of procedure occurrence records by condition occurrence start month\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009620 as analysis_id,   \n\u0009EXTRACT(YEAR FROM procedure_date)*100 + EXTRACT(MONTH FROM procedure_date) as stratum_1, \n\u0009COUNT(PERSON_ID) as count_value\nfrom\nomopv5_de.procedure_occurrence po1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on po1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id,\n\u0009EXTRACT(YEAR FROM procedure_date)*100 + EXTRACT(MONTH FROM procedure_date)\n;\n--\n\n\n--/********************************************\n\n--HERACLES Analyses on DRUG_EXPOSURE table\n\n--*********************************************/\n\n\n\n\n--\n-- 700\u0009Number of persons with at least one drug occurrence, by drug_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009700 as analysis_id, \n\u0009de1.drug_CONCEPT_ID as stratum_1,\n\u0009COUNT(distinct de1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.drug_exposure de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009de1.drug_CONCEPT_ID\n;\n--\n\n\n--\n-- 701\u0009Number of drug occurrence records, by drug_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009701 as analysis_id, \n\u0009de1.drug_CONCEPT_ID as stratum_1,\n\u0009COUNT(de1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.drug_exposure de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009de1.drug_CONCEPT_ID\n;\n--\n\n\n\n--\n-- 702\u0009Number of persons by drug occurrence start month, by drug_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id,\n\u0009702 as analysis_id,   \n\u0009de1.drug_concept_id as stratum_1,\n\u0009EXTRACT(YEAR FROM drug_exposure_start_date)*100 + EXTRACT(MONTH FROM drug_exposure_start_date) as stratum_2, \n\u0009COUNT(distinct PERSON_ID) as count_value\nfrom\nomopv5_de.drug_exposure de1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009de1.drug_concept_id, \n\u0009EXTRACT(YEAR FROM drug_exposure_start_date)*100 + EXTRACT(MONTH FROM drug_exposure_start_date)\n;\n--\n\n\n\n--\n-- 703\u0009Number of distinct drug exposure concepts per person\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009703 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect cohort_definition_id, num_drugs as count_value,\n\u00091.0*(row_number() over (partition by cohort_definition_id order by num_drugs))/(COUNT(num_drugs) over (partition by cohort_definition_id)+1) as p1\nfrom\n\u0009(\n\u0009select c1.cohort_definition_id, de1.person_id, COUNT(distinct de1.drug_concept_id) as num_drugs\n\u0009from\n\u0009omopv5_de.drug_exposure de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n\u0009group by c1.cohort_definition_id, de1.person_id\n\u0009) t0\n) t1\ngroup by cohort_definition_id\n;\n--\n\n\n\n--\n-- 704\u0009Number of persons with at least one drug occurrence, by drug_concept_id by calendar year by gender by age decile\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, stratum_3, stratum_4, count_value)\nselect c1.cohort_definition_id,\n\u0009704 as analysis_id,   \n\u0009de1.drug_concept_id as stratum_1,\n\u0009EXTRACT(YEAR FROM drug_exposure_start_date) as stratum_2,\n\u0009p1.gender_concept_id as stratum_3,\n\u0009floor((EXTRACT(YEAR FROM drug_exposure_start_date) - p1.year_of_birth)/10) as stratum_4, \n\u0009COUNT(distinct p1.PERSON_ID) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ninner join\nomopv5_de.drug_exposure de1\non p1.person_id = de1.person_id\n--\ngroup by c1.cohort_definition_id,\n\u0009de1.drug_concept_id, \n\u0009EXTRACT(YEAR FROM drug_exposure_start_date),\n\u0009p1.gender_concept_id,\n\u0009floor((EXTRACT(YEAR FROM drug_exposure_start_date) - p1.year_of_birth)/10)\n;\n--\n\n--\n-- 705\u0009Number of drug occurrence records, by drug_concept_id by drug_type_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id,\n\u0009705 as analysis_id, \n\u0009de1.drug_CONCEPT_ID as stratum_1,\n\u0009de1.drug_type_concept_id as stratum_2,\n\u0009COUNT(de1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.drug_exposure de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009de1.drug_CONCEPT_ID,\u0009\n\u0009de1.drug_type_concept_id\n;\n--\n\n\n\n--\n-- 706\u0009Distribution of age by drug_concept_id\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009706 as analysis_id,\n\u0009drug_concept_id as stratum_1,\n\u0009gender_concept_id as stratum_2,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009de1.drug_concept_id,\n\u0009p1.gender_concept_id,\n\u0009de1.drug_start_year - p1.year_of_birth as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id, de1.drug_concept_id, p1.gender_concept_id order by de1.drug_start_year - p1.year_of_birth))/(COUNT(de1.drug_start_year - p1.year_of_birth) over (partition by c1.cohort_definition_id, de1.drug_concept_id, p1.gender_concept_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on p1.person_id = c1.subject_id\ninner join\n(select person_id, drug_concept_id, min(EXTRACT(YEAR FROM drug_exposure_start_date)) as drug_start_year\nfrom omopv5_de.drug_exposure de0\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de0.person_id = c1.subject_id\n--\ngroup by person_id, drug_concept_id\n) de1\non p1.person_id = de1.person_id\n) t1\ngroup by cohort_definition_id, drug_concept_id, gender_concept_id\n;\n--\n\n\n\n\n--\n-- 709\u0009Number of drug exposure records with invalid person_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009709 as analysis_id,  \n\u0009COUNT(de1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.drug_exposure de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n\u0009left join omopv5_de.PERSON p1\n\u0009on p1.person_id = de1.person_id\n  WHERE  p1.person_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 710\u0009Number of drug exposure records outside valid observation period\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009710 as analysis_id,  \n\u0009COUNT(de1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.drug_exposure de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n\u0009left join omopv5_de.OBSERVATION_PERIOD op1\n\u0009on op1.person_id = de1.person_id\n\u0009and de1.drug_exposure_start_date >= op1.observation_period_start_date\n\u0009and de1.drug_exposure_start_date <= op1.observation_period_end_date\n  WHERE  op1.person_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 711\u0009Number of drug exposure records with end date < start date\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009711 as analysis_id,  \n\u0009COUNT(de1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.drug_exposure de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n  WHERE  de1.drug_exposure_end_date < de1.drug_exposure_start_date\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 712\u0009Number of drug exposure records with invalid provider_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009712 as analysis_id,  \n\u0009COUNT(de1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.drug_exposure de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n\u0009left join omopv5_de.provider p1\n\u0009on p1.provider_id =   de1.provider_id  \n  WHERE    de1.provider_id   is not null\n\u0009and p1.provider_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n--\n-- 713\u0009Number of drug exposure records with invalid visit_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009713 as analysis_id,  \n\u0009COUNT(de1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.drug_exposure de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n\u0009left join omopv5_de.visit_occurrence vo1\n\u0009on de1.visit_occurrence_id = vo1.visit_occurrence_id\n  WHERE  de1.visit_occurrence_id is not null\n\u0009and vo1.visit_occurrence_id is null\ngroup by cohort_definition_id\n;\n--\n\n\n\n--\n-- 715\u0009Distribution of days_supply by drug_concept_id\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009715 as analysis_id,\n\u0009drug_concept_id as stratum_1,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id, drug_concept_id,\n\u0009days_supply as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id, drug_concept_id order by days_supply))/(COUNT(days_supply) over (partition by c1.cohort_definition_id, drug_concept_id)+1) as p1\nfrom omopv5_de.drug_exposure de1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n--\n) t1\ngroup by cohort_definition_id, drug_concept_id\n;\n--\n\n\n\n--\n-- 716\u0009Distribution of refills by drug_concept_id\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id, \n\u0009716 as analysis_id,\n\u0009drug_concept_id as stratum_1,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009drug_concept_id,\n\u0009refills as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id, drug_concept_id order by refills))/(COUNT(refills) over (partition by c1.cohort_definition_id, drug_concept_id)+1) as p1\nfrom omopv5_de.drug_exposure de1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n--\n) t1\ngroup by cohort_definition_id, \n\u0009drug_concept_id\n;\n--\n\n\n\n\n\n--\n-- 717\u0009Distribution of quantity by drug_concept_id\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009717 as analysis_id,\n\u0009drug_concept_id as stratum_1,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id, \n\u0009drug_concept_id,\n\u0009quantity as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id, drug_concept_id order by quantity))/(COUNT(quantity) over (partition by cohort_definition_id, drug_concept_id)+1) as p1\nfrom omopv5_de.drug_exposure de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n--\n) t1\ngroup by cohort_definition_id, drug_concept_id\n;\n--\n\n\n--\n-- 720\u0009Number of drug exposure records by drug start month\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009720 as analysis_id,   \n\u0009EXTRACT(YEAR FROM drug_exposure_start_date)*100 + EXTRACT(MONTH FROM drug_exposure_start_date) as stratum_1, \n\u0009COUNT(PERSON_ID) as count_value\nfrom\nomopv5_de.drug_exposure de1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id,\n\u0009EXTRACT(YEAR FROM drug_exposure_start_date)*100 + EXTRACT(MONTH FROM drug_exposure_start_date)\n;\n--\n\n--/********************************************\n\n--HERACLES Analyses on OBSERVATION table\n\n--*********************************************/\n\n\n\n--\n-- 800\u0009Number of persons with at least one observation occurrence, by observation_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009800 as analysis_id, \n\u0009o1.observation_CONCEPT_ID as stratum_1,\n\u0009COUNT(distinct o1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.observation o1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on o1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009o1.observation_CONCEPT_ID\n;\n--\n\n\n--\n-- 801\u0009Number of observation occurrence records, by observation_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009801 as analysis_id, \n\u0009o1.observation_CONCEPT_ID as stratum_1,\n\u0009COUNT(o1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.observation o1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on o1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009o1.observation_CONCEPT_ID\n;\n--\n\n\n\n--\n-- 802\u0009Number of persons by observation occurrence start month, by observation_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id,\n\u0009802 as analysis_id,   \n\u0009o1.observation_concept_id as stratum_1,\n\u0009EXTRACT(YEAR FROM observation_date)*100 + EXTRACT(MONTH FROM observation_date) as stratum_2, \n\u0009COUNT(distinct PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.observation o1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on o1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009o1.observation_concept_id, \n\u0009EXTRACT(YEAR FROM observation_date)*100 + EXTRACT(MONTH FROM observation_date)\n;\n--\n\n\n\n--\n-- 803\u0009Number of distinct observation occurrence concepts per person\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009803 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect cohort_definition_id,\n\u0009num_observations as count_value,\n\u00091.0*(row_number() over (partition by cohort_definition_id order by num_observations))/(COUNT(num_observations) over (partition by cohort_definition_id)+1) as p1\nfrom\n\u0009(\n\u0009select c1.cohort_definition_id, o1.person_id, COUNT(distinct o1.observation_concept_id) as num_observations\n\u0009from\n\u0009omopv5_de.observation o1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on o1.person_id = c1.subject_id\n\u0009group by c1.cohort_definition_id, o1.person_id\n\u0009) t0\n) t1\ngroup by cohort_definition_id\n;\n--\n\n\n\n--\n-- 804\u0009Number of persons with at least one observation occurrence, by observation_concept_id by calendar year by gender by age decile\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, stratum_3, stratum_4, count_value)\nselect c1.cohort_definition_id,\n\u0009804 as analysis_id,   \n\u0009o1.observation_concept_id as stratum_1,\n\u0009EXTRACT(YEAR FROM observation_date) as stratum_2,\n\u0009p1.gender_concept_id as stratum_3,\n\u0009floor((EXTRACT(YEAR FROM observation_date) - p1.year_of_birth)/10) as stratum_4, \n\u0009COUNT(distinct p1.PERSON_ID) as count_value\nfrom omopv5_de.PERSON p1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on p1.person_id = c1.subject_id\ninner join\nomopv5_de.observation o1\non p1.person_id = o1.person_id\n--\ngroup by c1.cohort_definition_id,\n\u0009o1.observation_concept_id, \n\u0009EXTRACT(YEAR FROM observation_date),\n\u0009p1.gender_concept_id,\n\u0009floor((EXTRACT(YEAR FROM observation_date) - p1.year_of_birth)/10)\n;\n--\n\n--\n-- 805\u0009Number of observation occurrence records, by observation_concept_id by observation_type_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id,\n\u0009805 as analysis_id, \n\u0009o1.observation_CONCEPT_ID as stratum_1,\n\u0009o1.observation_type_concept_id as stratum_2,\n\u0009COUNT(o1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.observation o1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on o1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009o1.observation_CONCEPT_ID,\u0009\n\u0009o1.observation_type_concept_id\n;\n--\n\n\n\n--\n-- 806\u0009Distribution of age by observation_concept_id\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009806 as analysis_id,\n\u0009observation_concept_id as stratum_1,\n\u0009gender_concept_id as stratum_2,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009o1.observation_concept_id,\n\u0009p1.gender_concept_id,\n\u0009o1.observation_start_year - p1.year_of_birth as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id, o1.observation_concept_id, p1.gender_concept_id order by o1.observation_start_year - p1.year_of_birth))/(COUNT(o1.observation_start_year - p1.year_of_birth) over (partition by c1.cohort_definition_id, o1.observation_concept_id, p1.gender_concept_id)+1) as p1\nfrom omopv5_de.PERSON p1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on p1.person_id = c1.subject_id\ninner join\n(select person_id, observation_concept_id, min(EXTRACT(YEAR FROM observation_date)) as observation_start_year\nfrom omopv5_de.observation o1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on o1.person_id = c1.subject_id\n--\ngroup by person_id, observation_concept_id\n) o1\non p1.person_id = o1.person_id\n) t1\ngroup by cohort_definition_id, observation_concept_id, gender_concept_id\n;\n--\n\n--\n-- 807\u0009Number of observation occurrence records, by observation_concept_id and unit_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id,\n\u0009807 as analysis_id, \n\u0009o1.observation_CONCEPT_ID as stratum_1,\n\u0009o1.unit_concept_id as stratum_2,\n\u0009COUNT(o1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.observation o1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on o1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009o1.observation_CONCEPT_ID,\n\u0009o1.unit_concept_id\n;\n--\n\n\n\n\n\n--\n-- 809\u0009Number of observation records with invalid person_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009809 as analysis_id,  \n\u0009COUNT(o1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.observation o1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on o1.person_id = c1.subject_id\n\u0009left join omopv5_de.PERSON p1\n\u0009on p1.person_id = o1.person_id\n  WHERE  p1.person_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 810\u0009Number of observation records outside valid observation period\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009810 as analysis_id,  \n\u0009COUNT(o1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.observation o1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on o1.person_id = c1.subject_id\n\u0009left join omopv5_de.OBSERVATION_PERIOD op1\n\u0009on op1.person_id = o1.person_id\n\u0009and o1.observation_date >= op1.observation_period_start_date\n\u0009and o1.observation_date <= op1.observation_period_end_date\n  WHERE  op1.person_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n\n--\n-- 812\u0009Number of observation records with invalid provider_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009812 as analysis_id,  \n\u0009COUNT(o1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.observation o1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on o1.person_id = c1.subject_id\n\u0009left join omopv5_de.provider p1\n\u0009on p1.provider_id =   o1.provider_id  \n  WHERE    o1.provider_id   is not null\n\u0009and p1.provider_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n--\n-- 813\u0009Number of observation records with invalid visit_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009813 as analysis_id,  \n\u0009COUNT(o1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.observation o1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on o1.person_id = c1.subject_id\n\u0009left join omopv5_de.visit_occurrence vo1\n\u0009on o1.visit_occurrence_id = vo1.visit_occurrence_id\n  WHERE  o1.visit_occurrence_id is not null\n\u0009and vo1.visit_occurrence_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 814\u0009Number of observation records with no value (numeric, string, or concept)\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009814 as analysis_id,  \n\u0009COUNT(o1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.observation o1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on o1.person_id = c1.subject_id\n  WHERE  o1.value_as_number is null\n\u0009and o1.value_as_string is null\n\u0009and o1.value_as_concept_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 815\u0009Distribution of numeric values, by observation_concept_id and unit_concept_id\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009815 as analysis_id,\n\u0009observation_concept_id as stratum_1,\n\u0009unit_concept_id as stratum_2,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect cohort_definition_id,\n\u0009observation_concept_id, unit_concept_id,\n\u0009value_as_number as count_value,\n\u00091.0*(row_number() over (partition by cohort_definition_id, observation_concept_id, unit_concept_id order by value_as_number))/(COUNT(value_as_number) over (partition by cohort_definition_id, observation_concept_id, unit_concept_id)+1) as p1\nfrom omopv5_de.observation o1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on o1.person_id = c1.subject_id\nwhere o1.unit_concept_id is not null\n\u0009and o1.value_as_number is not null\n\u0009--\n) t1\ngroup by cohort_definition_id, observation_concept_id, unit_concept_id\n;\n--\n\n\n-- --end of if in CDMv5\n\n\n--\n-- 820\u0009Number of observation records by condition occurrence start month\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009820 as analysis_id,   \n\u0009EXTRACT(YEAR FROM observation_date)*100 + EXTRACT(MONTH FROM observation_date) as stratum_1, \n\u0009COUNT(PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.observation o1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on o1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id,\n\u0009EXTRACT(YEAR FROM observation_date)*100 + EXTRACT(MONTH FROM observation_date)\n;\n--\n\n\n\n\n--/********************************************\n\n--HERACLES Analyses on DRUG_ERA table\n\n--*********************************************/\n\n\n--\n-- 900\u0009Number of persons with at least one drug occurrence, by drug_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009900 as analysis_id, \n\u0009de1.drug_CONCEPT_ID as stratum_1,\n\u0009COUNT(distinct de1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.drug_era de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id, \n\u0009de1.drug_CONCEPT_ID\n;\n--\n\n\n--\n-- 901\u0009Number of drug occurrence records, by drug_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009901 as analysis_id, \n\u0009de1.drug_CONCEPT_ID as stratum_1,\n\u0009COUNT(de1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.drug_era de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009de1.drug_CONCEPT_ID\n;\n--\n\n\n\n--\n-- 902\u0009Number of persons by drug occurrence start month, by drug_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect cohort_definition_id,\n\u0009902 as analysis_id,   \n\u0009de1.drug_concept_id as stratum_1,\n\u0009EXTRACT(YEAR FROM drug_era_start_date)*100 + EXTRACT(MONTH FROM drug_era_start_date) as stratum_2, \n\u0009COUNT(distinct PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.drug_era de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009de1.drug_concept_id, \n\u0009EXTRACT(YEAR FROM drug_era_start_date)*100 + EXTRACT(MONTH FROM drug_era_start_date)\n;\n--\n\n\n\n--\n-- 903\u0009Number of distinct drug era concepts per person\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009903 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect cohort_definition_id,\n\u0009num_drugs as count_value,\n\u00091.0*(row_number() over (partition by cohort_definition_id order by num_drugs))/(COUNT(num_drugs) over (partition by cohort_definition_id)+1) as p1\nfrom\n\u0009(\n\u0009select c1.cohort_definition_id, de1.person_id, COUNT(distinct de1.drug_concept_id) as num_drugs\n\u0009from\n\u0009omopv5_de.drug_era de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n\u0009group by c1.cohort_definition_id, de1.person_id\n\u0009) t0\n) t1\ngroup by cohort_definition_id\n;\n--\n\n\n\n--\n-- 904\u0009Number of persons with at least one drug occurrence, by drug_concept_id by calendar year by gender by age decile\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, stratum_3, stratum_4, count_value)\nselect c1.cohort_definition_id,\n\u0009904 as analysis_id,   \n\u0009de1.drug_concept_id as stratum_1,\n\u0009EXTRACT(YEAR FROM drug_era_start_date) as stratum_2,\n\u0009p1.gender_concept_id as stratum_3,\n\u0009floor((EXTRACT(YEAR FROM drug_era_start_date) - p1.year_of_birth)/10) as stratum_4, \n\u0009COUNT(distinct p1.PERSON_ID) as count_value\nfrom omopv5_de.PERSON p1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on p1.person_id = c1.subject_id\ninner join\nomopv5_de.drug_era de1\non p1.person_id = de1.person_id\n--\ngroup by c1.cohort_definition_id,\n\u0009de1.drug_concept_id, \n\u0009EXTRACT(YEAR FROM drug_era_start_date),\n\u0009p1.gender_concept_id,\n\u0009floor((EXTRACT(YEAR FROM drug_era_start_date) - p1.year_of_birth)/10)\n;\n--\n\n\n\n\n--\n-- 906\u0009Distribution of age by drug_concept_id\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009906 as analysis_id,\n\u0009drug_concept_id as stratum_1,\n\u0009gender_concept_id as stratum_2,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009de1.drug_concept_id,\n\u0009p1.gender_concept_id,\n\u0009de1.drug_start_year - p1.year_of_birth as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id, de1.drug_concept_id, p1.gender_concept_id order by de1.drug_start_year - p1.year_of_birth))/(COUNT(de1.drug_start_year - p1.year_of_birth) over (partition by c1.cohort_definition_id, de1.drug_concept_id, p1.gender_concept_id)+1) as p1\nfrom omopv5_de.PERSON p1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on p1.person_id = c1.subject_id\ninner join\n(select person_id, drug_concept_id, min(EXTRACT(YEAR FROM drug_era_start_date)) as drug_start_year\nfrom omopv5_de.drug_era de0\n\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de0.person_id = c1.subject_id\n--\ngroup by person_id, drug_concept_id\n) de1\non p1.person_id = de1.person_id\n) t1\ngroup by cohort_definition_id, drug_concept_id, gender_concept_id\n;\n--\n\n\n\n\n\n--\n-- 907\u0009Distribution of drug era length, by drug_concept_id\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u0009907 as analysis_id,\n\u0009drug_concept_id as stratum_1,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect cohort_definition_id,\n\u0009drug_concept_id,\n\u0009( drug_era_end_date - drug_era_start_date) as count_value,\n\u00091.0*(row_number() over (partition by cohort_definition_id, drug_concept_id order by ( drug_era_end_date - drug_era_start_date)))/(COUNT(( drug_era_end_date - drug_era_start_date)) over (partition by cohort_definition_id, drug_concept_id)+1) as p1\nfrom  omopv5_de.drug_era de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n--\n) t1\ngroup by cohort_definition_id, \n\u0009drug_concept_id\n;\n--\n\n\n\n--\n-- 908\u0009Number of drug eras with invalid person\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009908 as analysis_id,  \n\u0009COUNT(de1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.drug_era de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n\u0009left join omopv5_de.PERSON p1\n\u0009on p1.person_id = de1.person_id\n  WHERE  p1.person_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 909\u0009Number of drug eras outside valid observation period\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009909 as analysis_id,  \n\u0009COUNT(de1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.drug_era de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n\u0009left join omopv5_de.OBSERVATION_PERIOD op1\n\u0009on op1.person_id = de1.person_id\n\u0009and de1.drug_era_start_date >= op1.observation_period_start_date\n\u0009and de1.drug_era_start_date <= op1.observation_period_end_date\n  WHERE  op1.person_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 910\u0009Number of drug eras with end date < start date\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u0009910 as analysis_id,  \n\u0009COUNT(de1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.drug_era de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\n  WHERE  de1.drug_era_end_date < de1.drug_era_start_date\ngroup by c1.cohort_definition_id\n;\n--\n\n\n\n--\n-- 920\u0009Number of drug era records by drug era start month\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u0009920 as analysis_id,   \n\u0009EXTRACT(YEAR FROM drug_era_start_date)*100 + EXTRACT(MONTH FROM drug_era_start_date) as stratum_1, \n\u0009COUNT(PERSON_ID) as count_value\nfrom\nomopv5_de.drug_era de1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on de1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id,\n\u0009EXTRACT(YEAR FROM drug_era_start_date)*100 + EXTRACT(MONTH FROM drug_era_start_date)\n;\n--\n\n\n\n\n\n--/********************************************\n\n--HERACLES Analyses on CONDITION_ERA table\n\n--*********************************************/\n\n\n--\n-- 1000\u0009Number of persons with at least one condition occurrence, by condition_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u00091000 as analysis_id, \n\u0009ce1.condition_CONCEPT_ID as stratum_1,\n\u0009COUNT(distinct ce1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.condition_era ce1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on ce1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009ce1.condition_CONCEPT_ID\n;\n--\n\n\n--\n-- 1001\u0009Number of condition occurrence records, by condition_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u00091001 as analysis_id, \n\u0009ce1.condition_CONCEPT_ID as stratum_1,\n\u0009COUNT(ce1.PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.condition_era ce1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on ce1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009ce1.condition_CONCEPT_ID\n;\n--\n\n\n\n--\n-- 1002\u0009Number of persons by condition occurrence start month, by condition_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id,\n\u00091002 as analysis_id,   \n\u0009ce1.condition_concept_id as stratum_1,\n\u0009EXTRACT(YEAR FROM condition_era_start_date)*100 + EXTRACT(MONTH FROM condition_era_start_date) as stratum_2, \n\u0009COUNT(distinct PERSON_ID) as count_value\nfrom\n\u0009omopv5_de.condition_era ce1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on ce1.person_id = c1.subject_id\n--\ngroup by c1.cohort_definition_id,\n\u0009ce1.condition_concept_id, \n\u0009EXTRACT(YEAR FROM condition_era_start_date)*100 + EXTRACT(MONTH FROM condition_era_start_date)\n;\n--\n\n\n\n--\n-- 1003\u0009Number of distinct condition era concepts per person\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u00091003 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect cohort_definition_id, num_conditions as count_value,\n\u00091.0*(row_number() over (partition by cohort_definition_id order by num_conditions))/(COUNT(num_conditions) over (partition by cohort_definition_id)+1) as p1\nfrom\n\u0009(\n\u0009select c1.cohort_definition_id, ce1.person_id, COUNT(distinct ce1.condition_concept_id) as num_conditions\n\u0009from\n\u0009omopv5_de.condition_era ce1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on ce1.person_id = c1.subject_id\n\u0009group by c1.cohort_definition_id, ce1.person_id\n\u0009) t0\n) t1\ngroup by cohort_definition_id\n;\n--\n\n\n\n--\n-- 1004\u0009Number of persons with at least one condition occurrence, by condition_concept_id by calendar year by gender by age decile\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, stratum_3, stratum_4, count_value)\nselect c1.cohort_definition_id,\n\u00091004 as analysis_id,   \n\u0009ce1.condition_concept_id as stratum_1,\n\u0009EXTRACT(YEAR FROM condition_era_start_date) as stratum_2,\n\u0009p1.gender_concept_id as stratum_3,\n\u0009floor((EXTRACT(YEAR FROM condition_era_start_date) - p1.year_of_birth)/10) as stratum_4, \n\u0009COUNT(distinct p1.PERSON_ID) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ninner join\nomopv5_de.condition_era ce1\non p1.person_id = ce1.person_id\n--\ngroup by c1.cohort_definition_id,\n\u0009ce1.condition_concept_id, \n\u0009EXTRACT(YEAR FROM condition_era_start_date),\n\u0009p1.gender_concept_id,\n\u0009floor((EXTRACT(YEAR FROM condition_era_start_date) - p1.year_of_birth)/10)\n;\n--\n\n\n\n\n--\n-- 1006\u0009Distribution of age by condition_concept_id\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u00091006 as analysis_id,\n\u0009condition_concept_id as stratum_1,\n\u0009gender_concept_id as stratum_2,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009ce1.condition_concept_id,\n\u0009p1.gender_concept_id,\n\u0009ce1.condition_start_year - p1.year_of_birth as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id, ce1.condition_concept_id, p1.gender_concept_id order by ce1.condition_start_year - p1.year_of_birth))/(COUNT(ce1.condition_start_year - p1.year_of_birth) over (partition by c1.cohort_definition_id, ce1.condition_concept_id, p1.gender_concept_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ninner join\n(select person_id, condition_concept_id, min(EXTRACT(YEAR FROM condition_era_start_date)) as condition_start_year\nfrom omopv5_de.condition_era ce0\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on ce0.person_id = c1.subject_id\n\u0009\u0009--\ngroup by person_id, condition_concept_id\n) ce1\non p1.person_id = ce1.person_id\n) t1\ngroup by cohort_definition_id, condition_concept_id, gender_concept_id\n;\n--\n\n\n\n\n\n--\n-- 1007\u0009Distribution of condition era length, by condition_concept_id\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u00091007 as analysis_id,\n\u0009condition_concept_id as stratum_1,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009condition_concept_id,\n\u0009( condition_era_end_date - condition_era_start_date) as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id, condition_concept_id order by ( condition_era_end_date - condition_era_start_date)))/(COUNT(( condition_era_end_date - condition_era_start_date)) over (partition by c1.cohort_definition_id, condition_concept_id)+1) as p1\nfrom  omopv5_de.condition_era ce1\ninner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009on ce1.person_id = c1.subject_id\n--\n) t1\ngroup by cohort_definition_id,\n\u0009condition_concept_id\n;\n--\n\n\n\n--\n-- 1008\u0009Number of condition eras with invalid person\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u00091008 as analysis_id,  \n\u0009COUNT(ce1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.condition_era ce1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on ce1.person_id = c1.subject_id\n\u0009left join omopv5_de.PERSON p1\n\u0009on p1.person_id = ce1.person_id\n  WHERE  p1.person_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 1009\u0009Number of condition eras outside valid observation period\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u00091009 as analysis_id,  \n\u0009COUNT(ce1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.condition_era ce1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on ce1.person_id = c1.subject_id\n\u0009left join omopv5_de.OBSERVATION_PERIOD op1\n\u0009on op1.person_id = ce1.person_id\n\u0009and ce1.condition_era_start_date >= op1.observation_period_start_date\n\u0009and ce1.condition_era_start_date <= op1.observation_period_end_date\n  WHERE  op1.person_id is null\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 1010\u0009Number of condition eras with end date < start date\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c1.cohort_definition_id,\n\u00091010 as analysis_id,  \n\u0009COUNT(ce1.PERSON_ID) as count_value\n FROM \n\u0009omopv5_de.condition_era ce1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on ce1.person_id = c1.subject_id\n  WHERE  ce1.condition_era_end_date < ce1.condition_era_start_date\ngroup by c1.cohort_definition_id\n;\n--\n\n\n--\n-- 1020\u0009Number of drug era records by drug era start month\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u00091020 as analysis_id,   \n\u0009EXTRACT(YEAR FROM condition_era_start_date)*100 + EXTRACT(MONTH FROM condition_era_start_date) as stratum_1, \n\u0009COUNT(PERSON_ID) as count_value\nfrom\nomopv5_de.condition_era ce1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on ce1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id,\n\u0009EXTRACT(YEAR FROM condition_era_start_date)*100 + EXTRACT(MONTH FROM condition_era_start_date)\n;\n--\n\n\n\n\n--/********************************************\n\n--HERACLES Analyses on LOCATION table\n\n--*********************************************/\n\n--\n-- 1100\u0009Number of persons by location 3-digit zip\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nSELECT   c1.cohort_definition_id, \n\u00091100 as analysis_id,  \n\u0009SUBSTR(l1.zip,0,3) as stratum_1, COUNT(distinct person_id) as count_value\n FROM  omopv5_de.PERSON p1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on p1.person_id = c1.subject_id\n\u0009inner join omopv5_de.LOCATION l1\n\u0009on p1.location_id = l1.location_id\n  WHERE  p1.location_id is not null\n\u0009and l1.zip is not null\ngroup by c1.cohort_definition_id,\n\u0009SUBSTR(l1.zip,0,3);\n--\n\n\n--\n-- 1101\u0009Number of persons by location state\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nSELECT   c1.cohort_definition_id, \n\u00091101 as analysis_id,  \n\u0009l1.state as stratum_1, COUNT(distinct person_id) as count_value\n FROM  omopv5_de.PERSON p1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on p1.person_id = c1.subject_id\n\u0009inner join omopv5_de.LOCATION l1\n\u0009on p1.location_id = l1.location_id\n  WHERE  p1.location_id is not null\n\u0009and l1.state is not null\ngroup by c1.cohort_definition_id,\n\u0009l1.state;\n--\n\n\n\n\n--/********************************************\n\n--HERACLES Analyses on CARE_SITE table\n--\n--*********************************************/\n\n\n--\n-- 1200\u0009Number of persons by place of service\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nSELECT   c1.cohort_definition_id, \n\u00091200 as analysis_id,  \n\u0009cs1.place_of_service_concept_id as stratum_1, \n\u0009COUNT(person_id) as count_value\n FROM  omopv5_de.PERSON p1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on p1.person_id = c1.subject_id\n\u0009inner join omopv5_de.care_site cs1\n\u0009on p1.care_site_id = cs1.care_site_id\n  WHERE  p1.care_site_id is not null\n\u0009and cs1.place_of_service_concept_id is not null\ngroup by c1.cohort_definition_id,\n\u0009cs1.place_of_service_concept_id;\n--\n\n\n--\n-- 1201\u0009Number of visits by place of service\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nSELECT   c1.cohort_definition_id, \n\u00091201 as analysis_id,  \n\u0009cs1.place_of_service_concept_id as stratum_1, \n\u0009COUNT(visit_occurrence_id) as count_value\n FROM  omopv5_de.visit_occurrence vo1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c1\n\u0009\u0009on vo1.person_id = c1.subject_id\n\u0009inner join omopv5_de.care_site cs1\n\u0009on vo1.care_site_id = cs1.care_site_id\n  WHERE  vo1.care_site_id is not null\n\u0009and cs1.place_of_service_concept_id is not null\ngroup by c1.cohort_definition_id,\n\u0009cs1.place_of_service_concept_id;\n--\n\n\n\n\n\n\n--/********************************************\n\n--HERACLES Analyses on COHORT table\n\n--*********************************************/\n\n--\n-- 1700\u0009Number of records by cohort_definition_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c2.cohort_definition_id, \n\u00091700 as analysis_id, \n\u0009c1.cohort_definition_id as stratum_1, \n\u0009COUNT(c1.subject_ID) as count_value\nfrom\n\u0009omopv5_de.cohort c1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c2\non c1.subject_id = c2.subject_id\ngroup by c2.cohort_definition_id,\n\u0009c1.cohort_definition_id\n;\n--\n\n\n--\n-- 1701\u0009Number of records with cohort end date < cohort start date\ninsert into HERACLES_results (cohort_definition_id, analysis_id, count_value)\nSELECT   c2.cohort_definition_id,\n\u00091701 as analysis_id, \n\u0009COUNT(c1.subject_ID) as count_value\n FROM \u0009\n\u0009omopv5_de.cohort c1\n\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c2\non c1.subject_id = c2.subject_id\n  WHERE  c1.cohort_end_date < c1.cohort_start_date\ngroup by c2.cohort_definition_id\n;\n--\n\n\n\n\n\n--/********************************************\n\n--HERACLES Analyses on analysis relative to selected COHORT\n\n--*********************************************/\n\n--\n-- 1800\u0009Number of persons by age, with age at cohort start\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u00091800 as analysis_id, \n\u0009EXTRACT(YEAR FROM c1.cohort_start_date) - p1.YEAR_OF_BIRTH as stratum_1, \n\u0009COUNT(p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id, EXTRACT(YEAR FROM c1.cohort_start_date) - p1.YEAR_OF_BIRTH\n;\n--\u0009\n\u0009\n\u0009\n\n--\n-- 1801\u0009Distribution of age at cohort start\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id, \n\u00091801 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009EXTRACT(YEAR FROM c1.cohort_start_date) - p1.YEAR_OF_BIRTH as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id order by EXTRACT(YEAR FROM c1.cohort_start_date) - p1.YEAR_OF_BIRTH))/(COUNT(EXTRACT(YEAR FROM c1.cohort_start_date) - p1.YEAR_OF_BIRTH) over (partition by c1.cohort_definition_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n) t1\ngroup by cohort_definition_id\n;\n\n--\n\u0009\n\n--\n-- 1802\u0009Distribution of age at cohort start by gender\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id, \n\u00091802 as analysis_id,\n\u0009gender_concept_id as stratum_1,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009p1.gender_concept_id,\n\u0009EXTRACT(YEAR FROM c1.cohort_start_date) - p1.YEAR_OF_BIRTH as count_value,\n\u00091.0*(row_number() over (partition by p1.gender_concept_id, c1.cohort_definition_id order by EXTRACT(YEAR FROM c1.cohort_start_date) - p1.YEAR_OF_BIRTH))/(COUNT(EXTRACT(YEAR FROM c1.cohort_start_date) - p1.YEAR_OF_BIRTH) over (partition by p1.gender_concept_id, c1.cohort_definition_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n) t1\ngroup by cohort_definition_id, gender_concept_id\n;\n--\u0009\n\u0009\n\u0009\n--\n-- 1803\u0009Distribution of age at cohort start by cohort start year\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id, \n\u00091803 as analysis_id,\n\u0009cohort_year as stratum_1,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009EXTRACT(YEAR FROM c1.cohort_start_date) as cohort_year,\n\u0009EXTRACT(YEAR FROM c1.cohort_start_date) - p1.YEAR_OF_BIRTH as count_value,\n\u00091.0*(row_number() over (partition by EXTRACT(YEAR FROM c1.cohort_start_date), c1.cohort_definition_id order by EXTRACT(YEAR FROM c1.cohort_start_date) - p1.YEAR_OF_BIRTH))/(COUNT(EXTRACT(YEAR FROM c1.cohort_start_date) - p1.YEAR_OF_BIRTH) over (partition by EXTRACT(YEAR FROM c1.cohort_start_date), c1.cohort_definition_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n) t1\ngroup by cohort_definition_id, cohort_year\n;\n--\u0009\n\n\n--\n-- 1804\u0009Number of persons by duration from cohort start to cohort end, in 30d increments\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id, \n\u00091804 as analysis_id,  \n\u0009floor(( c1.cohort_end_date -  c1.cohort_start_date)/30) as stratum_1, \n\u0009COUNT(distinct p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id, floor(( c1.cohort_end_date -  c1.cohort_start_date)/30)\n;\n--\u0009\n\u0009\n\u0009\n--\n-- 1805\u0009Number of persons by duration from observation start to cohort start, in 30d increments\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nSELECT   c1.cohort_definition_id, \n\u00091805 as analysis_id,  \n\u0009floor(( c1.cohort_start_date -  op1.observation_period_start_date)/30) as stratum_1, \n\u0009COUNT(distinct p1.person_id) as count_value\n FROM  omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join omopv5_de.observation_period op1\non p1.person_id = op1.person_id\n  WHERE  c1.cohort_start_date >= op1.observation_period_start_date\nand c1.cohort_start_date <= op1.observation_period_end_date\ngroup by c1.cohort_definition_id, floor(( c1.cohort_start_date -  op1.observation_period_start_date)/30)\n;\n--\u0009\n\u0009\n--\u0009\n-- 1806\u0009Number of persons by duration from cohort start to observation end, in 30d increments\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nSELECT   c1.cohort_definition_id, \n\u00091806 as analysis_id,  \n\u0009floor(( op1.observation_period_end_date -  c1.cohort_start_date)/30) as stratum_1, \n\u0009COUNT(distinct p1.person_id) as count_value\n FROM  omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join omopv5_de.observation_period op1\non p1.person_id = op1.person_id\n  WHERE  c1.cohort_start_date >= op1.observation_period_start_date\nand c1.cohort_start_date <= op1.observation_period_end_date\ngroup by c1.cohort_definition_id, floor(( op1.observation_period_end_date -  c1.cohort_start_date)/30)\n;\n--\u0009\n\n--\n-- 1807\u0009Number of persons by duration from cohort end to observation end, in 30d increments\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nSELECT   c1.cohort_definition_id, \n\u00091807 as analysis_id,  \n\u0009floor(( op1.observation_period_end_date -  c1.cohort_end_date)/30) as stratum_1, \n\u0009COUNT(distinct p1.person_id) as count_value\n FROM  omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join omopv5_de.observation_period op1\non p1.person_id = op1.person_id\n  WHERE  c1.cohort_start_date >= op1.observation_period_start_date\nand c1.cohort_start_date <= op1.observation_period_end_date\ngroup by c1.cohort_definition_id, floor(( op1.observation_period_end_date -  c1.cohort_end_date)/30)\n;\n--\u0009\n\u0009\u0009\n\u0009\n--\n-- 1808\u0009Distribution of duration (days) from cohort start to cohort end\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u00091808 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009( c1.cohort_end_date - c1.cohort_start_date) as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id order by ( c1.cohort_end_date - c1.cohort_start_date)))/(COUNT(( c1.cohort_end_date - c1.cohort_start_date)) over (partition by c1.cohort_definition_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n) t1\ngroup by cohort_definition_id\n;\n--\n\n\u0009\n--\n-- 1809\u0009Distribution of duration (days) from cohort start to cohort end, by gender\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u00091809 as analysis_id,\n\u0009gender_concept_id as stratum_1,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009p1.gender_concept_id,\n\u0009( c1.cohort_end_date - c1.cohort_start_date) as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id, p1.gender_concept_id order by ( c1.cohort_end_date - c1.cohort_start_date)))/(COUNT(( c1.cohort_end_date - c1.cohort_start_date)) over (partition by c1.cohort_definition_id, p1.gender_concept_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n) t1\ngroup by cohort_definition_id,\n\u0009gender_concept_id\n;\n--\n\u0009\n\u0009\n--\n-- 1810\u0009Distribution of duration (days) from cohort start to cohort end, by age decile\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, stratum_1, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u00091810 as analysis_id,\n\u0009age_decile as stratum_1,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009floor((EXTRACT(YEAR FROM c1.cohort_start_date) - p1.YEAR_OF_BIRTH)/10) as age_decile,\n\u0009( c1.cohort_end_date - c1.cohort_start_date) as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id, floor((EXTRACT(YEAR FROM c1.cohort_start_date) - p1.YEAR_OF_BIRTH)/10) order by ( c1.cohort_end_date - c1.cohort_start_date)))/(COUNT(( c1.cohort_end_date - c1.cohort_start_date)) over (partition by c1.cohort_definition_id, floor((EXTRACT(YEAR FROM c1.cohort_start_date) - p1.YEAR_OF_BIRTH)/10))+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\n) t1\ngroup by cohort_definition_id,\n\u0009age_decile\n;\n--\n\u0009\n--\n-- 1811\u0009Distribution of duration (days) from observation start to cohort start\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u00091811 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009( c1.cohort_start_date - op1.observation_period_start_date) as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id order by ( c1.cohort_start_date - op1.observation_period_start_date)))/(COUNT(( c1.cohort_start_date - op1.observation_period_start_date)) over (partition by c1.cohort_definition_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join omopv5_de.observation_period op1\non p1.person_id = op1.person_id\nwhere c1.cohort_start_date >= op1.observation_period_start_date\nand c1.cohort_start_date <= op1.observation_period_end_date\n) t1\ngroup by cohort_definition_id\n;\n--\n\u0009\n\u0009\n--\n-- 1812\u0009Distribution of duration (days) from cohort start to observation end\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u00091812 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009( op1.observation_period_end_date - c1.cohort_start_date) as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id order by ( op1.observation_period_end_date - c1.cohort_start_date)))/(COUNT(( op1.observation_period_end_date - c1.cohort_start_date)) over (partition by c1.cohort_definition_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join omopv5_de.observation_period op1\non p1.person_id = op1.person_id\nwhere c1.cohort_start_date >= op1.observation_period_start_date\nand c1.cohort_start_date <= op1.observation_period_end_date\n) t1\ngroup by cohort_definition_id\n;\n--\n\u0009\n\n--\n-- 1813\u0009Distribution of duration (days) from cohort end to observation end\ninsert into HERACLES_results_dist (cohort_definition_id, analysis_id, count_value, min_value, max_value, avg_value, stdev_value, median_value, p10_value, p25_value, p75_value, p90_value)\nselect cohort_definition_id,\n\u00091812 as analysis_id,\n\u0009COUNT(count_value) as count_value,\n\u0009min(count_value) as min_value,\n\u0009max(count_value) as max_value,\n\u0009avg(1.0*count_value) as avg_value,\n\u0009STDDEV(count_value) as stdev_value,\n\u0009max(case when p1<=0.50 then count_value else -9999 end) as median_value,\n\u0009max(case when p1<=0.10 then count_value else -9999 end) as p10_value,\n\u0009max(case when p1<=0.25 then count_value else -9999 end) as p25_value,\n\u0009max(case when p1<=0.75 then count_value else -9999 end) as p75_value,\n\u0009max(case when p1<=0.90 then count_value else -9999 end) as p90_value\nfrom\n(\nselect c1.cohort_definition_id,\n\u0009( op1.observation_period_end_date - c1.cohort_end_date) as count_value,\n\u00091.0*(row_number() over (partition by c1.cohort_definition_id order by ( op1.observation_period_end_date - c1.cohort_end_date)))/(COUNT(( op1.observation_period_end_date - c1.cohort_end_date)) over (partition by c1.cohort_definition_id)+1) as p1\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join omopv5_de.observation_period op1\non p1.person_id = op1.person_id\nwhere c1.cohort_start_date >= op1.observation_period_start_date\nand c1.cohort_start_date <= op1.observation_period_end_date\n) t1\ngroup by cohort_definition_id\n;\n--\n\n\u0009\n--\n-- 1814\u0009Number of persons by cohort start year by gender by age decile\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, stratum_3, count_value)\nselect c1.cohort_definition_id,\n\u00091814 as analysis_id,   \n\u0009EXTRACT(YEAR FROM c1.cohort_start_date) as stratum_1,\n\u0009p1.gender_concept_id as stratum_2,\n\u0009floor((EXTRACT(YEAR FROM c1.cohort_start_date) - p1.year_of_birth)/10) as stratum_3, \n\u0009COUNT(distinct p1.PERSON_ID) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id, \n\u0009EXTRACT(YEAR FROM c1.cohort_start_date),\n\u0009p1.gender_concept_id,\n\u0009floor((EXTRACT(YEAR FROM c1.cohort_start_date) - p1.year_of_birth)/10)\n;\n--\n\n\u0009\n--\n-- 1815\u0009Number of persons by cohort start month\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect c1.cohort_definition_id,\n\u00091815 as analysis_id,   \n\u0009EXTRACT(YEAR FROM c1.cohort_start_date)*100 + EXTRACT(MONTH FROM c1.cohort_start_date) as stratum_1, \n\u0009COUNT(distinct p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date from HERACLES_cohort) c1\n\u0009on p1.person_id = c1.subject_id\ngroup by c1.cohort_definition_id,\n\u0009EXTRACT(YEAR FROM c1.cohort_start_date)*100 + EXTRACT(MONTH FROM c1.cohort_start_date)\n;\n--\n\n\u0009\n--\n-- 1816\u0009Number of persons by number of cohort periods\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, count_value)\nselect cohort_definition_id, \n\u00091816 as analysis_id,  \n\u0009num_periods as stratum_1, \n\u0009COUNT(distinct person_id) as count_value\nfrom\n\u0009(select c1.cohort_definition_id, p1.person_id, COUNT(c1.cohort_start_date) as num_periods \n\u0009\u0009from omopv5_de.PERSON p1\n\u0009\u0009inner join (select subject_id, cohort_definition_id, cohort_start_date from HERACLES_cohort) c1\n\u0009\u0009\u0009on p1.person_id = c1.subject_id\n\u0009\u0009group by c1.cohort_definition_id, p1.person_id) nc1\ngroup by cohort_definition_id, num_periods\n;\n--\n\u0009\n\u0009\n--\n-- 1820\u0009Number of persons by duration from cohort start to first occurrence of condition occurrence, by condition_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id, \n\u00091820 as analysis_id,\n\u0009co1.condition_concept_id as stratum_1,\n\u0009case when c1.cohort_start_date = co1.first_date then 0\n\u0009\u0009when c1.cohort_start_date < co1.first_date then floor(( co1.first_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > co1.first_date then floor(( co1.first_date -  c1.cohort_start_date)/30)-1\n\u0009end as stratum_2, \n\u0009COUNT(distinct p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join\n\u0009(\n\u0009\u0009select co0.person_id, co0.condition_concept_id, min(co0.condition_start_date) as first_date\n\u0009\u0009from omopv5_de.condition_occurrence co0\n\u0009\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c0\n\u0009\u0009\u0009on co0.person_id = c0.subject_id\n\u0009\u0009--\n\u0009\u0009group by co0.person_id, co0.condition_concept_id\n\u0009) co1\non p1.person_id = co1.person_id\ngroup by c1.cohort_definition_id,\n\u0009co1.condition_concept_id,\n\u0009case when c1.cohort_start_date = co1.first_date then 0\n\u0009\u0009when c1.cohort_start_date < co1.first_date then floor(( co1.first_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > co1.first_date then floor(( co1.first_date -  c1.cohort_start_date)/30)-1\n\u0009end\n;\n--\u0009\n\u0009\n\u0009\n--\n-- 1821\u0009Number of events by duration from cohort start to all occurrences of condition occurrence, by condition_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id, \n\u00091821 as analysis_id,\n\u0009co1.condition_concept_id as stratum_1,\n\u0009case when c1.cohort_start_date = co1.condition_start_date then 0\n\u0009\u0009when c1.cohort_start_date < co1.condition_start_date then floor(( co1.condition_start_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > co1.condition_start_date then floor(( co1.condition_start_date -  c1.cohort_start_date)/30)-1\n\u0009end as stratum_2, \n\u0009COUNT(distinct p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join\n\u0009omopv5_de.condition_occurrence co1\non p1.person_id = co1.person_id\n--\ngroup by c1.cohort_definition_id,\n\u0009co1.condition_concept_id,\n\u0009case when c1.cohort_start_date = co1.condition_start_date then 0\n\u0009\u0009when c1.cohort_start_date < co1.condition_start_date then floor(( co1.condition_start_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > co1.condition_start_date then floor(( co1.condition_start_date -  c1.cohort_start_date)/30)-1\n\u0009end\n;\n--\u0009\n\u0009\n\u0009\n\u0009\n--\n-- 1830\u0009Number of persons by duration from cohort start to first occurrence of procedure occurrence, by procedure_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id, \n\u00091830 as analysis_id,\n\u0009po1.procedure_concept_id as stratum_1,\n\u0009case when c1.cohort_start_date = po1.first_date then 0\n\u0009\u0009when c1.cohort_start_date < po1.first_date then floor(( po1.first_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > po1.first_date then floor(( po1.first_date -  c1.cohort_start_date)/30)-1\n\u0009end as stratum_2, \n\u0009COUNT(distinct p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join\n\u0009(\n\u0009\u0009select po0.person_id, po0.procedure_concept_id, min(po0.procedure_date) as first_date\n\u0009\u0009from omopv5_de.procedure_occurrence po0\n\u0009\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c0\n\u0009\u0009\u0009on po0.person_id = c0.subject_id\n\u0009\u0009--\n\u0009\u0009group by po0.person_id, po0.procedure_concept_id\n\u0009) po1\non p1.person_id = po1.person_id\ngroup by c1.cohort_definition_id,\n\u0009po1.procedure_concept_id,\n\u0009case when c1.cohort_start_date = po1.first_date then 0\n\u0009\u0009when c1.cohort_start_date < po1.first_date then floor(( po1.first_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > po1.first_date then floor(( po1.first_date -  c1.cohort_start_date)/30)-1\n\u0009end\n;\n--\u0009\n\u0009\n\u0009\n--\n-- 1831\u0009Number of events by duration from cohort start to all occurrences of procedure occurrence, by procedure_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id, \n\u00091831 as analysis_id,\n\u0009po1.procedure_concept_id as stratum_1,\n\u0009case when c1.cohort_start_date = po1.procedure_date then 0\n\u0009\u0009when c1.cohort_start_date < po1.procedure_date then floor(( po1.procedure_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > po1.procedure_date then floor(( po1.procedure_date -  c1.cohort_start_date)/30)-1\n\u0009end as stratum_2, \n\u0009COUNT(distinct p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join\n\u0009omopv5_de.procedure_occurrence po1\non p1.person_id = po1.person_id\n\u0009\u0009--\ngroup by c1.cohort_definition_id,\n\u0009po1.procedure_concept_id,\n\u0009case when c1.cohort_start_date = po1.procedure_date then 0\n\u0009\u0009when c1.cohort_start_date < po1.procedure_date then floor(( po1.procedure_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > po1.procedure_date then floor(( po1.procedure_date -  c1.cohort_start_date)/30)-1\n\u0009end\n;\n--\u0009\u0009\n\u0009\n\u0009\n\n--\n-- 1840\u0009Number of persons by duration from cohort start to first occurrence of drug_exposure, by drug_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id, \n\u00091840 as analysis_id,\n\u0009de1.drug_concept_id as stratum_1,\n\u0009case when c1.cohort_start_date = de1.first_date then 0\n\u0009\u0009when c1.cohort_start_date < de1.first_date then floor(( de1.first_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > de1.first_date then floor(( de1.first_date -  c1.cohort_start_date)/30)-1\n\u0009end as stratum_2, \n\u0009COUNT(distinct p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join\n\u0009(\n\u0009\u0009select de0.person_id, de0.drug_concept_id, min(de0.drug_exposure_start_date) as first_date\n\u0009\u0009from omopv5_de.drug_exposure de0\n\u0009\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c0\n\u0009\u0009\u0009on de0.person_id = c0.subject_id\n\u0009\u0009\u0009--\n\u0009\u0009group by de0.person_id, de0.drug_concept_id\n\u0009) de1\non p1.person_id = de1.person_id\ngroup by c1.cohort_definition_id,\n\u0009de1.drug_concept_id,\n\u0009case when c1.cohort_start_date = de1.first_date then 0\n\u0009\u0009when c1.cohort_start_date < de1.first_date then floor(( de1.first_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > de1.first_date then floor(( de1.first_date -  c1.cohort_start_date)/30)-1\n\u0009end\n;\n--\u0009\n\u0009\n\u0009\n--\n-- 1841\u0009Number of events by duration from cohort start to all occurrences of drug_exposure, by drug_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id, \n\u00091841 as analysis_id,\n\u0009de1.drug_concept_id as stratum_1,\n\u0009case when c1.cohort_start_date = de1.drug_exposure_start_date then 0\n\u0009\u0009when c1.cohort_start_date < de1.drug_exposure_start_date then floor(( de1.drug_exposure_start_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > de1.drug_exposure_start_date then floor(( de1.drug_exposure_start_date -  c1.cohort_start_date)/30)-1\n\u0009end as stratum_2, \n\u0009COUNT(distinct p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join\n\u0009omopv5_de.drug_exposure de1\non p1.person_id = de1.person_id\n--\ngroup by c1.cohort_definition_id,\n\u0009de1.drug_concept_id,\n\u0009case when c1.cohort_start_date = de1.drug_exposure_start_date then 0\n\u0009\u0009when c1.cohort_start_date < de1.drug_exposure_start_date then floor(( de1.drug_exposure_start_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > de1.drug_exposure_start_date then floor(( de1.drug_exposure_start_date -  c1.cohort_start_date)/30)-1\n\u0009end\n;\n--\u0009\u0009\n\u0009\n\n--\n-- 1850\u0009Number of persons by duration from cohort start to first occurrence of observation, by observation_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id, \n\u00091850 as analysis_id,\n\u0009o1.observation_concept_id as stratum_1,\n\u0009case when c1.cohort_start_date = o1.first_date then 0\n\u0009\u0009when c1.cohort_start_date < o1.first_date then floor(( o1.first_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > o1.first_date then floor(( o1.first_date -  c1.cohort_start_date)/30)-1\n\u0009end as stratum_2, \n\u0009COUNT(distinct p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join\n\u0009(\n\u0009\u0009select o0.person_id, o0.observation_concept_id, min(o0.observation_date) as first_date\n\u0009\u0009from omopv5_de.observation o0\n\u0009\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c0\n\u0009\u0009\u0009on o0.person_id = c0.subject_id\n\u0009\u0009--\n\u0009\u0009group by o0.person_id, o0.observation_concept_id\n\u0009) o1\non p1.person_id = o1.person_id\ngroup by c1.cohort_definition_id,\n\u0009o1.observation_concept_id,\n\u0009case when c1.cohort_start_date = o1.first_date then 0\n\u0009\u0009when c1.cohort_start_date < o1.first_date then floor(( o1.first_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > o1.first_date then floor(( o1.first_date -  c1.cohort_start_date)/30)-1\n\u0009end\n;\n--\u0009\n\u0009\n\u0009\n--\n-- 1851\u0009Number of events by duration from cohort start to all occurrences of observation, by observation_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id, \n\u00091851 as analysis_id,\n\u0009o1.observation_concept_id as stratum_1,\n\u0009case when c1.cohort_start_date = o1.observation_date then 0\n\u0009\u0009when c1.cohort_start_date < o1.observation_date then floor(( o1.observation_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > o1.observation_date then floor(( o1.observation_date -  c1.cohort_start_date)/30)-1\n\u0009end as stratum_2, \n\u0009COUNT(distinct p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join\n\u0009omopv5_de.observation o1\non p1.person_id = o1.person_id\n\u0009\u0009--\ngroup by c1.cohort_definition_id,\n\u0009o1.observation_concept_id,\n\u0009case when c1.cohort_start_date = o1.observation_date then 0\n\u0009\u0009when c1.cohort_start_date < o1.observation_date then floor(( o1.observation_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > o1.observation_date then floor(( o1.observation_date -  c1.cohort_start_date)/30)-1\n\u0009end\n;\n--\n\n\u0009\n\n--\n-- 1860\u0009Number of persons by duration from cohort start to first occurrence of condition era, by condition_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id, \n\u00091860 as analysis_id,\n\u0009ce1.condition_concept_id as stratum_1,\n\u0009case when c1.cohort_start_date = ce1.first_date then 0\n\u0009\u0009when c1.cohort_start_date < ce1.first_date then floor(( ce1.first_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > ce1.first_date then floor(( ce1.first_date -  c1.cohort_start_date)/30)-1\n\u0009end as stratum_2, \n\u0009COUNT(distinct p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join\n\u0009(\n\u0009\u0009select ce0.person_id, ce0.condition_concept_id, min(ce0.condition_era_start_date) as first_date\n\u0009\u0009from omopv5_de.condition_era ce0\n\u0009\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c0\n\u0009\u0009\u0009on ce0.person_id = c0.subject_id\n\u0009\u0009\u0009--\n\u0009\u0009group by ce0.person_id, ce0.condition_concept_id\n\u0009) ce1\non p1.person_id = ce1.person_id\ngroup by c1.cohort_definition_id,\n\u0009ce1.condition_concept_id,\n\u0009case when c1.cohort_start_date = ce1.first_date then 0\n\u0009\u0009when c1.cohort_start_date < ce1.first_date then floor(( ce1.first_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > ce1.first_date then floor(( ce1.first_date -  c1.cohort_start_date)/30)-1\n\u0009end\n;\n--\u0009\n\u0009\n\u0009\n--\n-- 1861\u0009Number of events by duration from cohort start to all occurrences of condition era, by condition_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id, \n\u00091861 as analysis_id,\n\u0009ce1.condition_concept_id as stratum_1,\n\u0009case when c1.cohort_start_date = ce1.condition_era_start_date then 0\n\u0009\u0009when c1.cohort_start_date < ce1.condition_era_start_date then floor(( ce1.condition_era_start_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > ce1.condition_era_start_date then floor(( ce1.condition_era_start_date -  c1.cohort_start_date)/30)-1\n\u0009end as stratum_2, \n\u0009COUNT(distinct p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join\n\u0009omopv5_de.condition_era ce1\non p1.person_id = ce1.person_id\n--\ngroup by c1.cohort_definition_id,\n\u0009ce1.condition_concept_id,\n\u0009case when c1.cohort_start_date = ce1.condition_era_start_date then 0\n\u0009\u0009when c1.cohort_start_date < ce1.condition_era_start_date then floor(( ce1.condition_era_start_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > ce1.condition_era_start_date then floor(( ce1.condition_era_start_date -  c1.cohort_start_date)/30)-1\n\u0009end\n;\n--\u0009\n\n\u0009\n\u0009\n--\n-- 1870\u0009Number of persons by duration from cohort start to first occurrence of drug era, by drug_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id, \n\u00091870 as analysis_id,\n\u0009de1.drug_concept_id as stratum_1,\n\u0009case when c1.cohort_start_date = de1.first_date then 0\n\u0009\u0009when c1.cohort_start_date < de1.first_date then floor(( de1.first_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > de1.first_date then floor(( de1.first_date -  c1.cohort_start_date)/30)-1\n\u0009end as stratum_2, \n\u0009COUNT(distinct p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join\n\u0009(\n\u0009\u0009select de0.person_id, de0.drug_concept_id, min(de0.drug_era_start_date) as first_date\n\u0009\u0009from omopv5_de.drug_era de0\n\u0009\u0009\u0009inner join (select subject_id, cohort_definition_id from HERACLES_cohort) c0\n\u0009\u0009\u0009on de0.person_id = c0.subject_id\n\u0009\u0009--\n\u0009\u0009group by de0.person_id, de0.drug_concept_id\n\u0009) de1\non p1.person_id = de1.person_id\ngroup by c1.cohort_definition_id,\n\u0009de1.drug_concept_id,\n\u0009case when c1.cohort_start_date = de1.first_date then 0\n\u0009\u0009when c1.cohort_start_date < de1.first_date then floor(( de1.first_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > de1.first_date then floor(( de1.first_date -  c1.cohort_start_date)/30)-1\n\u0009end\n;\n--\u0009\n\u0009\n\u0009\n--\n-- 1871\u0009Number of events by duration from cohort start to all occurrences of drug era, by drug_concept_id\ninsert into HERACLES_results (cohort_definition_id, analysis_id, stratum_1, stratum_2, count_value)\nselect c1.cohort_definition_id, \n\u00091871 as analysis_id,\n\u0009de1.drug_concept_id as stratum_1,\n\u0009case when c1.cohort_start_date = de1.drug_era_start_date then 0\n\u0009\u0009when c1.cohort_start_date < de1.drug_era_start_date then floor(( de1.drug_era_start_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > de1.drug_era_start_date then floor(( de1.drug_era_start_date -  c1.cohort_start_date)/30)-1\n\u0009end as stratum_2, \n\u0009COUNT(distinct p1.person_id) as count_value\nfrom omopv5_de.PERSON p1\ninner join (select subject_id, cohort_definition_id, cohort_start_date, cohort_end_date from HERACLES_cohort) c1\non p1.person_id = c1.subject_id\ninner join\n\u0009omopv5_de.drug_era de1\non p1.person_id = de1.person_id\n--\ngroup by c1.cohort_definition_id,\n\u0009de1.drug_concept_id,\n\u0009case when c1.cohort_start_date = de1.drug_era_start_date then 0\n\u0009\u0009when c1.cohort_start_date < de1.drug_era_start_date then floor(( de1.drug_era_start_date -  c1.cohort_start_date)/30)+1\n\u0009\u0009when c1.cohort_start_date > de1.drug_era_start_date then floor(( de1.drug_era_start_date -  c1.cohort_start_date)/30)-1\n\u0009end\n;\n--\u0009\n\nTRUNCATE TABLE HERACLES_cohort;\nDROP TABLE HERACLES_cohort;\n\n\ndelete from HERACLES_results where count_value <= 0;\ndelete from HERACLES_results_dist where count_value <= 0;\n\n--\n\n END;\n";
        final String finalSql = "DECLARE BEGIN " + sql + " END;";
        log.debug("Tweaked SQL: " + sql);

        try {
            final List<SqlParameter> params = new LinkedList<SqlParameter>();
            final Map<String, Object> ret = this.jdbcTemplate.call(new CallableStatementCreator() {
                
                @Override
                public CallableStatement createCallableStatement(final Connection con) throws SQLException {
                    final CallableStatement cs = con.prepareCall(finalSql);
                    return cs;
                }
            }, params);
            log.debug(ret);
        } catch (final Exception e) {
            log.error(e.getMessage(), e);
        }
        return RepeatStatus.FINISHED;
    }
    
}
;
